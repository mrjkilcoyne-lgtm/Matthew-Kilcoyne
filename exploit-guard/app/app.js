// ExploitGuard - Complete Standalone Security Suite
// All security services and UI in a single file
const h = React.createElement;
const { useState, useEffect, useRef } = React;

// ============================================================
// SVG Icon Components
// ============================================================
const Icon = (props) => h('svg', { xmlns: 'http://www.w3.org/2000/svg', width: props.size || 20, height: props.size || 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', className: props.className || '' }, ...(props.children || []));

const ShieldIcon = (p) => Icon(p, h('path', {d:'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10'}));
const ScanIcon = (p) => Icon(p, h('path',{d:'M3 7V5a2 2 0 0 1 2-2h2'}), h('path',{d:'M17 3h2a2 2 0 0 1 2 2v2'}), h('path',{d:'M21 17v2a2 2 0 0 1-2 2h-2'}), h('path',{d:'M7 21H5a2 2 0 0 1-2-2v-2'}), h('line',{x1:'7',y1:'12',x2:'17',y2:'12'}));
const GlobeIcon = (p) => Icon(p, h('circle',{cx:'12',cy:'12',r:'10'}), h('line',{x1:'2',y1:'12',x2:'22',y2:'12'}), h('path',{d:'M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z'}));
const LockIcon = (p) => Icon(p, h('rect',{x:'3',y:'11',width:'18',height:'11',rx:'2',ry:'2'}), h('path',{d:'M7 11V7a5 5 0 0 1 10 0v4'}));
const FileIcon = (p) => Icon(p, h('path',{d:'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z'}), h('polyline',{points:'14 2 14 8 20 8'}));
const SmartphoneIcon = (p) => Icon(p, h('rect',{x:'5',y:'2',width:'14',height:'20',rx:'2',ry:'2'}), h('line',{x1:'12',y1:'18',x2:'12.01',y2:'18'}));
const WifiIcon = (p) => Icon(p, h('path',{d:'M5 12.55a11 11 0 0 1 14.08 0'}), h('path',{d:'M1.42 9a16 16 0 0 1 21.16 0'}), h('path',{d:'M8.53 16.11a6 6 0 0 1 6.95 0'}), h('line',{x1:'12',y1:'20',x2:'12.01',y2:'20'}));
const AlertIcon = (p) => Icon(p, h('path',{d:'M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z'}), h('line',{x1:'12',y1:'9',x2:'12',y2:'13'}), h('line',{x1:'12',y1:'17',x2:'12.01',y2:'17'}));
const MessageIcon = (p) => Icon(p, h('path',{d:'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'}));
const BarChartIcon = (p) => Icon(p, h('line',{x1:'12',y1:'20',x2:'12',y2:'10'}), h('line',{x1:'18',y1:'20',x2:'18',y2:'4'}), h('line',{x1:'6',y1:'20',x2:'6',y2:'16'}));
const MenuIcon = (p) => Icon(p, h('line',{x1:'3',y1:'12',x2:'21',y2:'12'}), h('line',{x1:'3',y1:'6',x2:'21',y2:'6'}), h('line',{x1:'3',y1:'18',x2:'21',y2:'18'}));
const SearchIcon = (p) => Icon(p, h('circle',{cx:'11',cy:'11',r:'8'}), h('line',{x1:'21',y1:'21',x2:'16.65',y2:'16.65'}));
const CheckIcon = (p) => Icon(p, h('path',{d:'M22 11.08V12a10 10 0 1 1-5.93-9.14'}), h('polyline',{points:'22 4 12 14.01 9 11.01'}));
const XCircleIcon = (p) => Icon(p, h('circle',{cx:'12',cy:'12',r:'10'}), h('line',{x1:'15',y1:'9',x2:'9',y2:'15'}), h('line',{x1:'9',y1:'9',x2:'15',y2:'15'}));
const ExternalIcon = (p) => Icon(p, h('path',{d:'M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6'}), h('polyline',{points:'15 3 21 3 21 9'}), h('line',{x1:'10',y1:'14',x2:'21',y2:'3'}));
const UploadIcon = (p) => Icon(p, h('polyline',{points:'16 16 12 12 8 16'}), h('line',{x1:'12',y1:'12',x2:'12',y2:'21'}), h('path',{d:'M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3'}));
const SendIcon = (p) => Icon(p, h('line',{x1:'22',y1:'2',x2:'11',y2:'13'}), h('polygon',{points:'22 2 15 22 11 13 2 9 22 2'}));
const TrashIcon = (p) => Icon(p, h('polyline',{points:'3 6 5 6 21 6'}), h('path',{d:'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2'}));
const TrophyIcon = (p) => Icon({...p}, h('path',{d:'M6 9H4.5a2.5 2.5 0 0 1 0-5H6'}), h('path',{d:'M18 9h1.5a2.5 2.5 0 0 0 0-5H18'}), h('path',{d:'M4 22h16'}), h('path',{d:'M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22'}), h('path',{d:'M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22'}), h('path',{d:'M18 2H6v7a6 6 0 0 0 12 0V2Z'}));
const BugIcon = (p) => Icon(p, h('rect',{width:'8',height:'14',x:'8',y:'6',rx:'4'}), h('path',{d:'m19 7-3 2'}), h('path',{d:'m5 7 3 2'}), h('path',{d:'m19 19-3-2'}), h('path',{d:'m5 19 3-2'}), h('path',{d:'M20 13h-4'}), h('path',{d:'M4 13h4'}), h('path',{d:'m10 4 1 2'}), h('path',{d:'m14 4-1 2'}));
const ChevronRightIcon = (p) => Icon(p, h('polyline',{points:'9 18 15 12 9 6'}));
const RadioIcon = (p) => Icon(p, h('circle',{cx:'12',cy:'12',r:'2'}), h('path',{d:'M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14'}));
const SparklesIcon = (p) => Icon(p, h('path',{d:'m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z'}));
const UserIcon = (p) => Icon(p, h('path',{d:'M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2'}), h('circle',{cx:'12',cy:'7',r:'4'}));
const BotIcon = (p) => Icon(p, h('path',{d:'M12 8V4H8'}), h('rect',{width:'16',height:'12',x:'4',y:'8',rx:'2'}), h('path',{d:'M2 14h2'}), h('path',{d:'M20 14h2'}), h('path',{d:'M15 13v2'}), h('path',{d:'M9 13v2'}));
const TrendUpIcon = (p) => Icon(p, h('polyline',{points:'23 6 13.5 15.5 8.5 10.5 1 18'}), h('polyline',{points:'17 6 23 6 23 12'}));
const TrendDownIcon = (p) => Icon(p, h('polyline',{points:'23 18 13.5 8.5 8.5 13.5 1 6'}), h('polyline',{points:'17 18 23 18 23 12'}));
const ClockIcon = (p) => Icon(p, h('circle',{cx:'12',cy:'12',r:'10'}), h('polyline',{points:'12 6 12 12 16 14'}));
const HashIcon = (p) => Icon(p, h('line',{x1:'4',y1:'9',x2:'20',y2:'9'}), h('line',{x1:'4',y1:'15',x2:'20',y2:'15'}), h('line',{x1:'10',y1:'3',x2:'8',y2:'21'}), h('line',{x1:'16',y1:'3',x2:'14',y2:'21'}));
const CameraIcon = (p) => Icon(p, h('path',{d:'M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z'}), h('circle',{cx:'12',cy:'13',r:'4'}));
const MicIcon = (p) => Icon(p, h('path',{d:'M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z'}), h('path',{d:'M19 10v2a7 7 0 0 1-14 0v-2'}), h('line',{x1:'12',y1:'19',x2:'12',y2:'23'}), h('line',{x1:'8',y1:'23',x2:'16',y2:'23'}));
const MapPinIcon = (p) => Icon(p, h('path',{d:'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'}), h('circle',{cx:'12',cy:'10',r:'3'}));
const MailIcon = (p) => Icon(p, h('path',{d:'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z'}), h('polyline',{points:'22,6 12,13 2,6'}));
const PhoneIcon = (p) => Icon(p, h('path',{d:'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z'}));


// ============================================================
// Security Data & Services
// ============================================================
const KNOWN_CVES = [
  { id:'CVE-2024-53104', severity:'HIGH', description:'USB Video Class driver out-of-bounds write vulnerability in Linux kernel, actively exploited on Android devices.', affected:['Android 12','Android 13','Android 14','Android 15'], patched:'2025-02-01', published:'2024-12-02', cvss:7.8, exploit:true },
  { id:'CVE-2024-53197', severity:'HIGH', description:'Linux kernel ALSA USB audio driver out-of-bounds access, exploited in targeted attacks.', affected:['Android 13','Android 14','Android 15'], patched:'2025-04-01', published:'2024-12-27', cvss:7.8, exploit:true },
  { id:'CVE-2025-27363', severity:'HIGH', description:'FreeType library out-of-bounds write when parsing TrueType GX and variable font files.', affected:['Android 13','Android 14','Android 15'], patched:'2025-05-01', published:'2025-03-11', cvss:8.1, exploit:true },
  { id:'CVE-2024-43093', severity:'HIGH', description:'Android Framework privilege escalation allowing unauthorized access to sensitive directories.', affected:['Android 12','Android 13','Android 14','Android 15'], patched:'2024-11-01', published:'2024-11-04', cvss:7.8, exploit:true },
  { id:'CVE-2024-43047', severity:'HIGH', description:'Qualcomm DSP Service use-after-free vulnerability, exploited in targeted surveillance campaigns.', affected:['Android 12','Android 13','Android 14'], patched:'2024-11-01', published:'2024-10-07', cvss:7.8, exploit:true },
  { id:'CVE-2024-36971', severity:'HIGH', description:'Linux kernel network route management use-after-free enabling remote code execution.', affected:['Android 12','Android 13','Android 14'], patched:'2024-08-01', published:'2024-06-10', cvss:7.8, exploit:true },
  { id:'CVE-2024-32896', severity:'HIGH', description:'Pixel firmware logic error allowing privilege escalation through user interaction.', affected:['Android 14','Android 15'], patched:'2024-09-01', published:'2024-06-13', cvss:7.8, exploit:true },
  { id:'CVE-2023-40088', severity:'CRITICAL', description:'Bluetooth callback use-after-free in Android System leading to remote code execution.', affected:['Android 11','Android 12','Android 13','Android 14'], patched:'2023-12-01', published:'2023-12-04', cvss:8.8, exploit:true },
  { id:'CVE-2023-4863', severity:'CRITICAL', description:'libwebp heap buffer overflow affecting Chrome, Android WebView, and numerous applications.', affected:['Android 11','Android 12','Android 13','Android 14'], patched:'2023-10-01', published:'2023-09-12', cvss:8.8, exploit:true },
  { id:'CVE-2023-21036', severity:'HIGH', description:'aCropalypse: Pixel Markup tool fails to truncate edited screenshots, exposing cropped content.', affected:['Android 10','Android 11','Android 12','Android 13'], patched:'2023-03-01', published:'2023-03-24', cvss:7.5, exploit:true },
  { id:'CVE-2024-0044', severity:'HIGH', description:'Android run-as vulnerability allowing any app to impersonate other applications.', affected:['Android 12','Android 12L','Android 13','Android 14'], patched:'2024-04-01', published:'2024-03-11', cvss:7.8, exploit:true },
  { id:'CVE-2023-45779', severity:'HIGH', description:'APEX module installation flaw allowing unsigned code to persist across reboots.', affected:['Android 13','Android 14'], patched:'2023-12-01', published:'2024-01-08', cvss:7.8, exploit:true },
];

const DEVICE_DB = [
  { brand:'Google', model:'Pixel 9 Pro', os:'15', score:95, vulns:1, updates:'Monthly', until:'2031-10' },
  { brand:'Google', model:'Pixel 9', os:'15', score:94, vulns:1, updates:'Monthly', until:'2031-10' },
  { brand:'Google', model:'Pixel 8 Pro', os:'15', score:93, vulns:2, updates:'Monthly', until:'2030-10' },
  { brand:'Google', model:'Pixel 8', os:'15', score:92, vulns:2, updates:'Monthly', until:'2030-10' },
  { brand:'Google', model:'Pixel 7', os:'15', score:88, vulns:3, updates:'Monthly', until:'2027-10' },
  { brand:'Google', model:'Pixel 6', os:'15', score:82, vulns:4, updates:'Quarterly', until:'2027-06' },
  { brand:'Samsung', model:'Galaxy S25 Ultra', os:'15', score:93, vulns:1, updates:'Monthly', until:'2031-01' },
  { brand:'Samsung', model:'Galaxy S25', os:'15', score:92, vulns:2, updates:'Monthly', until:'2031-01' },
  { brand:'Samsung', model:'Galaxy S24 Ultra', os:'15', score:90, vulns:2, updates:'Monthly', until:'2030-01' },
  { brand:'Samsung', model:'Galaxy S24', os:'15', score:89, vulns:3, updates:'Monthly', until:'2030-01' },
  { brand:'Samsung', model:'Galaxy S23', os:'14', score:85, vulns:4, updates:'Monthly', until:'2028-02' },
  { brand:'Samsung', model:'Galaxy A54', os:'14', score:80, vulns:5, updates:'Quarterly', until:'2027-03' },
  { brand:'OnePlus', model:'OnePlus 13', os:'15', score:88, vulns:3, updates:'Monthly', until:'2029-01' },
  { brand:'OnePlus', model:'OnePlus 12', os:'15', score:85, vulns:4, updates:'Quarterly', until:'2028-01' },
  { brand:'Xiaomi', model:'Xiaomi 15 Pro', os:'15', score:85, vulns:3, updates:'Monthly', until:'2029-01' },
  { brand:'Xiaomi', model:'Xiaomi 14', os:'14', score:80, vulns:5, updates:'Quarterly', until:'2027-02' },
  { brand:'Xiaomi', model:'Redmi Note 13', os:'14', score:72, vulns:6, updates:'Quarterly', until:'2027-01' },
  { brand:'Apple', model:'iPhone 16 Pro', os:'iOS 18', score:96, vulns:1, updates:'Monthly', until:'2030-09' },
  { brand:'Apple', model:'iPhone 15', os:'iOS 18', score:95, vulns:1, updates:'Monthly', until:'2029-09' },
  { brand:'Apple', model:'iPhone 14', os:'iOS 18', score:93, vulns:2, updates:'Monthly', until:'2028-09' },
  { brand:'Apple', model:'iPhone 13', os:'iOS 17', score:88, vulns:3, updates:'Monthly', until:'2027-09' },
  { brand:'Nothing', model:'Phone 2a', os:'14', score:78, vulns:5, updates:'Quarterly', until:'2027-03' },
  { brand:'Motorola', model:'Edge 50 Pro', os:'14', score:75, vulns:6, updates:'Quarterly', until:'2027-04' },
  { brand:'Samsung', model:'Galaxy S20', os:'13', score:55, vulns:9, updates:'EOL', until:'2024-10' },
  { brand:'Google', model:'Pixel 4', os:'13', score:35, vulns:12, updates:'EOL', until:'2023-06' },
  { brand:'Huawei', model:'P30 Pro', os:'12', score:25, vulns:15, updates:'EOL', until:'2022-12' },
].sort((a,b) => b.score - a.score);

const SUSPICIOUS_TLDS = ['.xyz','.top','.buzz','.gq','.ml','.tk','.cf','.ga','.work','.click','.loan'];
const BLOCKLIST = new Set(['secure-login-verify.com','account-recovery-help.net','free-prize-winner.com','update-your-password.org','urgent-security-alert.com']);
const LOOKALIKE_BRANDS = ['paypal','google','apple','microsoft','amazon','facebook','netflix','instagram','whatsapp'];

function scanURL(inputUrl) {
  let url = inputUrl.trim();
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
  try {
    const obj = new URL(url);
    const domain = obj.hostname.toLowerCase();
    let risk = 0;
    const threats = [];
    if (BLOCKLIST.has(domain)) return { url, safe: false, threat: 'PHISHING', risk: 95, ssl: false, threats: ['Known phishing domain'] };
    if (SUSPICIOUS_TLDS.some(t => domain.endsWith(t))) { risk += 20; threats.push('Suspicious TLD'); }
    if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(domain)) { risk += 25; threats.push('IP address instead of domain'); }
    if (domain.split('.').length > 4) { risk += 15; threats.push('Excessive subdomains'); }
    for (const brand of LOOKALIKE_BRANDS) {
      if (domain.includes(brand) && domain !== brand+'.com' && domain !== 'www.'+brand+'.com') { risk += 30; threats.push('Possible '+brand+' impersonation'); break; }
    }
    if (domain.startsWith('xn--')) { risk += 20; threats.push('IDN homograph attack possible'); }
    const ssl = obj.protocol === 'https:';
    if (!ssl) { risk += 15; threats.push('No HTTPS encryption'); }
    risk = Math.min(risk, 100);
    return { url, safe: risk < 30, threat: risk >= 70 ? 'PHISHING' : risk >= 50 ? 'SUSPICIOUS' : risk >= 30 ? 'SPAM' : null, risk, ssl, threats };
  } catch(e) {
    return { url: inputUrl, safe: false, threat: 'SUSPICIOUS', risk: 50, ssl: false, threats: ['Invalid URL format'] };
  }
}

function scanDevice(osVer, patchLevel) {
  const major = parseInt(osVer);
  const androidVer = 'Android ' + major;
  const pd = new Date(patchLevel);
  const matched = KNOWN_CVES.filter(cve => {
    const affected = cve.affected.some(v => v === androidVer || v.startsWith('Android '+major));
    if (!affected) return false;
    if (cve.patched) return pd < new Date(cve.patched);
    return true;
  });
  return {
    total: matched.length,
    critical: matched.filter(c => c.severity === 'CRITICAL').length,
    high: matched.filter(c => c.severity === 'HIGH').length,
    cves: matched,
    scanDate: new Date().toISOString()
  };
}

async function hashFileSHA256(file) {
  const buf = await file.arrayBuffer();
  const hash = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function auditPermissions() {
  if (!navigator.permissions) return [];
  const perms = ['camera','microphone','geolocation','notifications','clipboard-read','clipboard-write','persistent-storage'];
  const results = [];
  for (const name of perms) {
    try {
      const r = await navigator.permissions.query({ name });
      results.push({ name, granted: r.state === 'granted', state: r.state, danger: ['camera','microphone','geolocation','clipboard-read'].includes(name) });
    } catch(e) {}
  }
  return results;
}

function getScoreColor(s) {
  if (s >= 85) return '#22c55e';
  if (s >= 70) return '#84cc16';
  if (s >= 55) return '#eab308';
  if (s >= 40) return '#f97316';
  return '#ef4444';
}

function getGrade(s) {
  if (s >= 95) return 'A+';
  if (s >= 85) return 'A';
  if (s >= 70) return 'B';
  if (s >= 55) return 'C';
  if (s >= 40) return 'D';
  return 'F';
}

function calcScore(osVer, vulnCount) {
  let s = 100;
  const v = parseInt(osVer) || 14;
  if (v < 13) s -= 20;
  else if (v < 14) s -= 10;
  else if (v < 15) s -= 5;
  s -= vulnCount * 5;
  return Math.max(0, Math.min(100, s));
}

// ============================================================
// Shared UI Components
// ============================================================
function ScoreRing({ score, grade, size = 160 }) {
  const r = (size - 8) / 2;
  const c = 2 * Math.PI * r;
  const off = c - (score / 100) * c;
  const color = getScoreColor(score);
  return h('div', { className: 'flex flex-col items-center gap-2' },
    h('div', { className: 'relative', style: { width: size, height: size } },
      h('svg', { width: size, height: size, className: 'transform -rotate-90' },
        h('circle', { cx: size/2, cy: size/2, r, fill: 'none', stroke: '#262626', strokeWidth: 8 }),
        h('circle', { cx: size/2, cy: size/2, r, fill: 'none', stroke: color, strokeWidth: 8, strokeLinecap: 'round', strokeDasharray: c, strokeDashoffset: off, style: { transition: 'stroke-dashoffset 1s ease-out' } })
      ),
      h('div', { className: 'absolute inset-0 flex flex-col items-center justify-center' },
        h('span', { className: 'text-3xl font-bold', style: { color } }, score),
        h('span', { className: 'text-lg font-semibold text-neutral-400' }, grade)
      )
    )
  );
}

function SeverityBadge({ severity, size = 'sm' }) {
  const styles = {
    CRITICAL: 'bg-red-500/20 text-red-400 border-red-500/30',
    HIGH: 'bg-orange-500/20 text-orange-400 border-orange-500/30',
    MEDIUM: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
    LOW: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
    SAFE: 'bg-green-500/20 text-green-400 border-green-500/30',
    DANGER: 'bg-red-500/20 text-red-400 border-red-500/30',
    WARNING: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
    INFO: 'bg-neutral-500/20 text-neutral-400 border-neutral-500/30',
    NONE: 'bg-green-500/20 text-green-400 border-green-500/30',
  };
  const s = styles[severity] || styles.INFO;
  const sz = size === 'sm' ? 'text-xs px-2 py-0.5' : 'text-sm px-3 py-1';
  return h('span', { className: `inline-flex items-center rounded-full border font-medium ${s} ${sz}` }, severity);
}

function StatCard({ title, value, subtitle, icon, color = 'green', onClick }) {
  const colors = {
    green: 'bg-green-500/10 text-green-400 border-green-500/20',
    red: 'bg-red-500/10 text-red-400 border-red-500/20',
    yellow: 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20',
    blue: 'bg-blue-500/10 text-blue-400 border-blue-500/20',
    purple: 'bg-purple-500/10 text-purple-400 border-purple-500/20',
    orange: 'bg-orange-500/10 text-orange-400 border-orange-500/20',
  };
  const iconColors = {
    green: 'bg-green-500/20 text-green-400',
    red: 'bg-red-500/20 text-red-400',
    yellow: 'bg-yellow-500/20 text-yellow-400',
    blue: 'bg-blue-500/20 text-blue-400',
    purple: 'bg-purple-500/20 text-purple-400',
    orange: 'bg-orange-500/20 text-orange-400',
  };
  return h('button', { onClick, disabled: !onClick, className: `w-full text-left p-5 rounded-2xl border transition-all ${colors[color]} ${onClick ? 'hover:scale-[1.02] cursor-pointer' : 'cursor-default'}` },
    h('div', { className: 'flex items-start justify-between' },
      h('div', null,
        h('p', { className: 'text-sm text-neutral-400 mb-1' }, title),
        h('p', { className: 'text-2xl font-bold text-white' }, value),
        subtitle && h('p', { className: 'text-xs text-neutral-500 mt-1' }, subtitle)
      ),
      h('div', { className: `w-10 h-10 rounded-xl flex items-center justify-center ${iconColors[color]}` }, icon)
    )
  );
}

// ============================================================
// Page: Dashboard
// ============================================================
function DashboardPage({ onNav }) {
  const [score, setScore] = useState(null);
  const [vulns, setVulns] = useState(null);
  const [perms, setPerms] = useState(0);
  const [scanning, setScanning] = useState(true);

  useEffect(() => {
    (async () => {
      const v = scanDevice('14', '2025-01-01');
      setVulns(v);
      const p = await auditPermissions();
      setPerms(p.filter(x => x.danger && x.granted).length);
      const s = calcScore('14', v.total);
      setScore(s);
      setScanning(false);
    })();
  }, []);

  if (scanning) return h('div', { className: 'flex flex-col items-center justify-center min-h-[60vh] gap-6' },
    h('div', { className: 'relative' },
      h('div', { className: 'w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center animate-scan-pulse' }, h(ShieldIcon, { size: 48, className: 'text-green-400' })),
      h('div', { className: 'absolute inset-0 rounded-full border-2 border-green-500/30 animate-ping' })
    ),
    h('div', { className: 'text-center' },
      h('p', { className: 'text-xl font-semibold text-white' }, 'Scanning Device Security...'),
      h('p', { className: 'text-neutral-500 mt-2' }, 'Checking vulnerabilities, permissions, and threats')
    )
  );

  if (!vulns) return null;
  const grade = getGrade(score);

  return h('div', { className: 'space-y-8 max-w-7xl mx-auto' },
    // Score Hero
    h('div', { className: 'bg-neutral-900/50 rounded-3xl border border-neutral-800 p-8' },
      h('div', { className: 'flex flex-col md:flex-row items-center gap-8' },
        h(ScoreRing, { score, grade, size: 180 }),
        h('div', { className: 'flex-1 text-center md:text-left' },
          h('h3', { className: 'text-2xl font-bold text-white mb-2' }, 'Security Score'),
          h('p', { className: 'text-neutral-400 mb-4' }, score >= 85 ? 'Your device is well protected' : score >= 55 ? 'Some areas need attention' : 'Significant vulnerabilities present'),
        )
      )
    ),
    // Quick Stats
    h('div', { className: 'grid grid-cols-2 lg:grid-cols-4 gap-4' },
      h(StatCard, { title: 'Vulnerabilities', value: vulns.total, subtitle: vulns.critical + ' critical', icon: h(BugIcon, { size: 20 }), color: vulns.critical > 0 ? 'red' : vulns.total > 0 ? 'yellow' : 'green', onClick: () => onNav('vulnerabilities') }),
      h(StatCard, { title: 'Dangerous Permissions', value: perms, subtitle: 'granted to sites', icon: h(LockIcon, { size: 20 }), color: perms > 3 ? 'red' : perms > 0 ? 'yellow' : 'green', onClick: () => onNav('permissions') }),
      h(StatCard, { title: 'Patch Level', value: '2025-01', subtitle: 'Check for updates', icon: h(ShieldIcon, { size: 20 }), color: 'orange' }),
      h(StatCard, { title: 'Stalkerware', value: '0', subtitle: 'None detected', icon: h(AlertIcon, { size: 20 }), color: 'green' })
    ),
    // Quick Actions
    h('div', null,
      h('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Quick Actions'),
      h('div', { className: 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3' },
        ...[
          { icon: h(ScanIcon, { size: 20 }), label: 'Scan CVEs', page: 'vulnerabilities', color: 'text-red-400' },
          { icon: h(GlobeIcon, { size: 20 }), label: 'Check URL', page: 'url-scanner', color: 'text-blue-400' },
          { icon: h(FileIcon, { size: 20 }), label: 'Scan File', page: 'file-scanner', color: 'text-purple-400' },
          { icon: h(WifiIcon, { size: 20 }), label: 'Wi-Fi Check', page: 'wifi', color: 'text-cyan-400' },
          { icon: h(SmartphoneIcon, { size: 20 }), label: 'Compare Devices', page: 'devices', color: 'text-orange-400' },
        ].map(a => h('button', { key: a.page, onClick: () => onNav(a.page), className: 'flex flex-col items-center gap-2 p-4 bg-neutral-900/50 rounded-2xl border border-neutral-800 hover:border-neutral-700 hover:bg-neutral-800/50 transition-all' },
          h('div', { className: a.color }, a.icon),
          h('span', { className: 'text-sm text-neutral-300' }, a.label)
        ))
      )
    ),
    // Recent CVEs
    vulns.cves.length > 0 && h('div', null,
      h('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Recent Vulnerabilities'),
      h('div', { className: 'space-y-3' },
        ...vulns.cves.slice(0, 5).map(cve =>
          h('div', { key: cve.id, className: 'bg-neutral-900/50 rounded-xl border border-neutral-800 p-4 flex items-start gap-4 hover:border-neutral-700 transition-colors' },
            h(SeverityBadge, { severity: cve.severity }),
            h('div', { className: 'flex-1 min-w-0' },
              h('div', { className: 'flex items-center gap-2 mb-1' },
                h('span', { className: 'font-mono text-sm font-semibold text-white' }, cve.id),
                h('span', { className: 'text-xs text-neutral-500' }, 'CVSS ' + cve.cvss)
              ),
              h('p', { className: 'text-sm text-neutral-400 line-clamp-2' }, cve.description)
            ),
            cve.exploit && h('span', { className: 'text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded-full border border-red-500/30 whitespace-nowrap' }, 'Exploit Available')
          )
        )
      )
    )
  );
}

// ============================================================
// Page: Vulnerability Scanner
// ============================================================
function VulnScannerPage() {
  const [osVer, setOsVer] = useState('14');
  const [patch, setPatch] = useState('2025-01-01');
  const [result, setResult] = useState(null);
  const [filter, setFilter] = useState('ALL');
  const [search, setSearch] = useState('');

  function run() { setResult(scanDevice(osVer, patch)); }

  const cves = result ? result.cves : KNOWN_CVES;
  const filtered = cves.filter(c => {
    if (filter !== 'ALL' && c.severity !== filter) return false;
    if (search && !c.id.toLowerCase().includes(search.toLowerCase()) && !c.description.toLowerCase().includes(search.toLowerCase())) return false;
    return true;
  });

  return h('div', { className: 'space-y-6 max-w-5xl mx-auto' },
    h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
      h('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Device Configuration'),
      h('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
        h('div', null,
          h('label', { className: 'text-sm text-neutral-400 block mb-2' }, 'Android Version'),
          h('select', { value: osVer, onChange: e => setOsVer(e.target.value), className: 'w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-green-500/50' },
            ...['15','14','13','12','11','10'].map(v => h('option', { key: v, value: v }, 'Android ' + v))
          )
        ),
        h('div', null,
          h('label', { className: 'text-sm text-neutral-400 block mb-2' }, 'Security Patch Level'),
          h('input', { type: 'date', value: patch, onChange: e => setPatch(e.target.value), className: 'w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-green-500/50' })
        ),
        h('div', { className: 'flex items-end' },
          h('button', { onClick: run, className: 'w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-500 text-white font-semibold py-3 px-6 rounded-xl transition-all' },
            h(ScanIcon, { size: 18 }), 'Scan'
          )
        )
      )
    ),
    result && h('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-3' },
      h('div', { className: 'bg-neutral-900/50 rounded-xl border border-neutral-800 p-4 text-center' }, h('p', { className: 'text-2xl font-bold text-white' }, result.total), h('p', { className: 'text-xs text-neutral-500' }, 'Total')),
      h('div', { className: 'bg-red-500/10 rounded-xl border border-red-500/20 p-4 text-center' }, h('p', { className: 'text-2xl font-bold text-red-400' }, result.critical), h('p', { className: 'text-xs text-neutral-500' }, 'Critical')),
      h('div', { className: 'bg-orange-500/10 rounded-xl border border-orange-500/20 p-4 text-center' }, h('p', { className: 'text-2xl font-bold text-orange-400' }, result.high), h('p', { className: 'text-xs text-neutral-500' }, 'High')),
      h('div', { className: 'bg-neutral-900/50 rounded-xl border border-neutral-800 p-4 text-center' }, h('p', { className: 'text-2xl font-bold text-white' }, new Date(result.scanDate).toLocaleDateString()), h('p', { className: 'text-xs text-neutral-500' }, 'Scan Date'))
    ),
    h('div', { className: 'flex flex-col md:flex-row gap-4' },
      h('input', { type: 'text', placeholder: 'Search CVEs...', value: search, onChange: e => setSearch(e.target.value), className: 'flex-1 bg-neutral-900/50 border border-neutral-800 rounded-xl px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-green-500/50' }),
      h('div', { className: 'flex gap-2 overflow-x-auto scrollbar-hide' },
        ...['ALL','CRITICAL','HIGH','MEDIUM','LOW'].map(s =>
          h('button', { key: s, onClick: () => setFilter(s), className: `px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${filter === s ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-neutral-800 text-neutral-400 border border-neutral-700 hover:bg-neutral-700'}` }, s)
        )
      )
    ),
    h('div', { className: 'space-y-3' },
      filtered.length === 0
        ? h('div', { className: 'text-center py-12' }, h(CheckIcon, { size: 48, className: 'text-green-400 mx-auto mb-4' }), h('p', { className: 'text-lg font-semibold text-white' }, 'No vulnerabilities found'))
        : filtered.map(cve => h('div', { key: cve.id, className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5 hover:border-neutral-700 transition-all' },
            h('div', { className: 'flex items-start justify-between gap-4 mb-3' },
              h('div', { className: 'flex items-center gap-3' },
                h(SeverityBadge, { severity: cve.severity, size: 'md' }),
                h('span', { className: 'font-mono text-base font-bold text-white' }, cve.id),
                cve.cvss && h('span', { className: 'text-sm text-neutral-500' }, 'CVSS ' + cve.cvss)
              ),
              cve.exploit && h('span', { className: 'text-xs bg-red-500/20 text-red-400 px-2.5 py-1 rounded-full border border-red-500/30' }, 'Exploit Available')
            ),
            h('p', { className: 'text-sm text-neutral-300 mb-3' }, cve.description),
            h('div', { className: 'flex flex-wrap gap-4 text-xs text-neutral-500' },
              h('span', null, 'Published: ' + new Date(cve.published).toLocaleDateString()),
              cve.patched && h('span', null, 'Patched: ' + cve.patched),
              h('span', null, 'Affected: ' + cve.affected.join(', '))
            )
          ))
    )
  );
}

// ============================================================
// Page: URL Scanner
// ============================================================
function URLScannerPage() {
  const [url, setUrl] = useState('');
  const [result, setResult] = useState(null);
  const [history, setHistory] = useState([]);

  function run() {
    if (!url.trim()) return;
    const r = scanURL(url);
    setResult(r);
    setHistory(prev => [r, ...prev.slice(0, 9)]);
  }

  return h('div', { className: 'space-y-6 max-w-4xl mx-auto' },
    h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
      h('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Scan a URL for Threats'),
      h('div', { className: 'flex gap-3' },
        h('div', { className: 'flex-1 relative' },
          h('div', { className: 'absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500' }, h(GlobeIcon, { size: 18 })),
          h('input', { type: 'text', value: url, onChange: e => setUrl(e.target.value), onKeyDown: e => e.key === 'Enter' && run(), placeholder: 'Enter URL to scan...', className: 'w-full bg-neutral-800 border border-neutral-700 rounded-xl pl-11 pr-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-green-500/50' })
        ),
        h('button', { onClick: run, disabled: !url.trim(), className: 'flex items-center gap-2 bg-green-600 hover:bg-green-500 disabled:bg-neutral-700 text-white font-semibold py-3 px-6 rounded-xl transition-all' }, h(SearchIcon, { size: 18 }), 'Scan')
      )
    ),
    result && h('div', { className: `bg-neutral-900/50 rounded-2xl border p-6 animate-slide-up ${result.safe ? 'border-green-500/30' : 'border-red-500/30'}` },
      h('div', { className: 'flex items-center gap-4 mb-6' },
        result.safe
          ? h('div', { className: 'w-14 h-14 bg-green-500/20 rounded-2xl flex items-center justify-center' }, h(CheckIcon, { size: 32, className: 'text-green-400' }))
          : h('div', { className: 'w-14 h-14 bg-red-500/20 rounded-2xl flex items-center justify-center' }, h(XCircleIcon, { size: 32, className: 'text-red-400' })),
        h('div', null,
          h('h3', { className: 'text-xl font-bold text-white' }, result.safe ? 'URL Appears Safe' : 'Potential Threat Detected'),
          h('p', { className: 'text-neutral-400 text-sm truncate max-w-md' }, result.url)
        )
      ),
      h('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-6' },
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'Risk Score'), h('p', { className: `text-2xl font-bold ${result.risk >= 70 ? 'text-red-400' : result.risk >= 40 ? 'text-yellow-400' : 'text-green-400'}` }, result.risk + '/100')),
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'Threat Type'), h('p', { className: 'text-lg font-semibold text-white' }, result.threat || 'None')),
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'SSL/HTTPS'), h('div', { className: 'flex items-center gap-2' }, result.ssl ? h(LockIcon, { size: 16, className: 'text-green-400' }) : h(AlertIcon, { size: 16, className: 'text-red-400' }), h('span', { className: `font-semibold ${result.ssl ? 'text-green-400' : 'text-red-400'}` }, result.ssl ? 'Valid' : 'Missing'))),
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'Findings'), h('p', { className: 'text-lg font-semibold text-white' }, result.threats.length))
      ),
      result.threats.length > 0 && h('div', { className: 'space-y-2' },
        ...result.threats.map((t, i) => h('div', { key: i, className: 'flex items-start gap-3 bg-neutral-800/30 rounded-xl p-3' },
          h(AlertIcon, { size: 16, className: 'text-yellow-400 shrink-0 mt-0.5' }),
          h('span', { className: 'text-sm text-neutral-300' }, t)
        ))
      )
    ),
    history.length > 0 && h('div', null,
      h('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Recent Scans'),
      h('div', { className: 'space-y-2' },
        ...history.map((s, i) => h('div', { key: i, className: 'bg-neutral-900/50 rounded-xl border border-neutral-800 p-4 flex items-center gap-4' },
          s.safe ? h(CheckIcon, { size: 20, className: 'text-green-400 shrink-0' }) : h(XCircleIcon, { size: 20, className: 'text-red-400 shrink-0' }),
          h('div', { className: 'flex-1 min-w-0' },
            h('p', { className: 'text-sm text-white truncate' }, s.url),
            h('p', { className: 'text-xs text-neutral-500' }, 'Risk: ' + s.risk + '/100')
          )
        ))
      )
    )
  );
}

// ============================================================
// Page: Permission Audit
// ============================================================
function PermissionAuditPage() {
  const [perms, setPerms] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => { auditPermissions().then(p => { setPerms(p); setLoading(false); }); }, []);

  if (loading) return h('div', { className: 'flex flex-col items-center justify-center min-h-[40vh] gap-4' },
    h(LockIcon, { size: 48, className: 'text-green-400 animate-pulse' }),
    h('p', { className: 'text-neutral-400' }, 'Auditing permissions...')
  );

  const granted = perms.filter(p => p.granted).length;
  const dangerous = perms.filter(p => p.danger).length;

  return h('div', { className: 'space-y-6 max-w-4xl mx-auto' },
    h('div', { className: 'grid grid-cols-3 gap-4' },
      h('div', { className: 'bg-neutral-900/50 rounded-xl border border-neutral-800 p-4 text-center' }, h('p', { className: 'text-2xl font-bold text-white' }, perms.length), h('p', { className: 'text-xs text-neutral-500' }, 'Checked')),
      h('div', { className: 'bg-green-500/10 rounded-xl border border-green-500/20 p-4 text-center' }, h('p', { className: 'text-2xl font-bold text-green-400' }, granted), h('p', { className: 'text-xs text-neutral-500' }, 'Granted')),
      h('div', { className: 'bg-red-500/10 rounded-xl border border-red-500/20 p-4 text-center' }, h('p', { className: 'text-2xl font-bold text-red-400' }, dangerous), h('p', { className: 'text-xs text-neutral-500' }, 'Sensitive'))
    ),
    h('div', { className: 'space-y-3' },
      ...perms.map(p => h('div', { key: p.name, className: `rounded-2xl border p-5 ${p.danger ? 'bg-red-500/5 border-red-500/20' : 'bg-neutral-900/50 border-neutral-800'}` },
        h('div', { className: 'flex items-center justify-between' },
          h('div', null,
            h('span', { className: 'font-mono text-sm font-semibold text-white' }, p.name),
            h('span', { className: `ml-3 text-xs px-2 py-0.5 rounded-full border ${p.granted ? 'bg-green-500/20 text-green-400 border-green-500/30' : 'bg-neutral-700 text-neutral-400 border-neutral-600'}` }, p.state.toUpperCase())
          ),
          p.danger && h(AlertIcon, { size: 16, className: 'text-red-400' })
        )
      ))
    ),
    h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
      h('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Best Practices'),
      h('div', { className: 'space-y-3 text-sm text-neutral-400' },
        h('div', { className: 'flex gap-3' }, h(CameraIcon, { size: 16, className: 'text-red-400 shrink-0 mt-0.5' }), h('span', null, 'Only grant camera access to apps that genuinely need it')),
        h('div', { className: 'flex gap-3' }, h(MicIcon, { size: 16, className: 'text-red-400 shrink-0 mt-0.5' }), h('span', null, 'Microphone access should be limited to communication apps')),
        h('div', { className: 'flex gap-3' }, h(MapPinIcon, { size: 16, className: 'text-orange-400 shrink-0 mt-0.5' }), h('span', null, 'Use "While using the app" for location instead of "Always allow"'))
      )
    )
  );
}

// ============================================================
// Page: File Scanner
// ============================================================
function FileScannerPage() {
  const [result, setResult] = useState(null);
  const [scanning, setScanning] = useState(false);
  const [dragActive, setDragActive] = useState(false);
  const fileRef = useRef(null);

  async function scan(file) {
    setScanning(true); setResult(null);
    const sha256 = await hashFileSHA256(file);
    const ext = file.name.includes('.') ? file.name.substring(file.name.lastIndexOf('.')) : '';
    const susExts = new Set(['.exe','.bat','.cmd','.vbs','.ps1','.scr','.apk','.dex','.jar','.msi']);
    const detections = [];
    let malicious = false;
    if (susExts.has(ext.toLowerCase())) { detections.push('Suspicious file type: ' + ext); }
    const parts = file.name.split('.');
    if (parts.length > 2 && susExts.has('.' + parts[parts.length-1].toLowerCase())) { detections.push('Double extension - possible disguised executable'); malicious = true; }
    if (file.size === 0) detections.push('Empty file (0 bytes)');
    if (file.size > 100*1024*1024) detections.push('Unusually large file (>100MB)');
    if (file.type.startsWith('text/') || ext === '.js' || ext === '.html') {
      try {
        const text = await file.text();
        if (/\beval\s*\(/i.test(text)) { detections.push('Contains eval() - potential code injection'); malicious = true; }
        if (/[A-Za-z0-9+\/]{50,}={0,2}/.test(text)) detections.push('Contains long base64-encoded string');
        if (/powershell|invoke-expression/i.test(text)) { detections.push('Contains PowerShell references'); malicious = true; }
      } catch(e) {}
    }
    setResult({ name: file.name, size: file.size, sha256, detections, malicious });
    setScanning(false);
  }

  function fmt(bytes) { if (!bytes) return '0 B'; const k = 1024; const s = ['B','KB','MB','GB']; const i = Math.floor(Math.log(bytes)/Math.log(k)); return (bytes/Math.pow(k,i)).toFixed(1)+' '+s[i]; }

  return h('div', { className: 'space-y-6 max-w-4xl mx-auto' },
    h('div', {
      onDragOver: e => { e.preventDefault(); setDragActive(true); },
      onDragLeave: () => setDragActive(false),
      onDrop: e => { e.preventDefault(); setDragActive(false); if (e.dataTransfer.files[0]) scan(e.dataTransfer.files[0]); },
      onClick: () => fileRef.current?.click(),
      className: `bg-neutral-900/50 rounded-2xl border-2 border-dashed p-12 text-center cursor-pointer transition-all ${dragActive ? 'border-green-500 bg-green-500/5' : 'border-neutral-700 hover:border-neutral-600'} ${scanning ? 'pointer-events-none opacity-60' : ''}`
    },
      h('input', { ref: fileRef, type: 'file', onChange: e => e.target.files[0] && scan(e.target.files[0]), className: 'hidden' }),
      scanning
        ? h('div', null, h(FileIcon, { size: 48, className: 'mx-auto text-green-400 animate-pulse mb-4' }), h('p', { className: 'text-lg font-semibold text-white' }, 'Scanning file...'))
        : h('div', null, h(UploadIcon, { size: 48, className: 'mx-auto text-neutral-500 mb-4' }), h('p', { className: 'text-lg font-semibold text-white' }, 'Drop a file here or click to browse'), h('p', { className: 'text-neutral-500 mt-2' }, 'Checks hashes, extensions, and content patterns'))
    ),
    result && h('div', { className: `bg-neutral-900/50 rounded-2xl border p-6 animate-slide-up ${result.malicious ? 'border-red-500/30' : result.detections.length > 0 ? 'border-yellow-500/30' : 'border-green-500/30'}` },
      h('div', { className: 'flex items-center gap-4 mb-6' },
        result.malicious
          ? h('div', { className: 'w-14 h-14 bg-red-500/20 rounded-2xl flex items-center justify-center' }, h(XCircleIcon, { size: 32, className: 'text-red-400' }))
          : result.detections.length > 0
            ? h('div', { className: 'w-14 h-14 bg-yellow-500/20 rounded-2xl flex items-center justify-center' }, h(AlertIcon, { size: 32, className: 'text-yellow-400' }))
            : h('div', { className: 'w-14 h-14 bg-green-500/20 rounded-2xl flex items-center justify-center' }, h(CheckIcon, { size: 32, className: 'text-green-400' })),
        h('div', null,
          h('h3', { className: 'text-xl font-bold text-white' }, result.malicious ? 'Threat Detected!' : result.detections.length > 0 ? 'Suspicious Findings' : 'File Appears Safe'),
          h('p', { className: 'text-neutral-400' }, result.name)
        )
      ),
      h('div', { className: 'grid grid-cols-2 gap-4 mb-6' },
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'File Size'), h('p', { className: 'text-sm font-semibold text-white' }, fmt(result.size))),
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'Detections'), h('p', { className: 'text-sm font-semibold text-white' }, result.detections.length))
      ),
      h('div', { className: 'bg-neutral-800/30 rounded-xl p-4 mb-4' },
        h('h4', { className: 'text-sm font-semibold text-white mb-3 flex items-center gap-2' }, h(HashIcon, { size: 14 }), 'SHA-256'),
        h('p', { className: 'font-mono text-xs text-neutral-300 break-all' }, result.sha256)
      ),
      result.detections.length > 0 && h('div', { className: 'space-y-2' },
        ...result.detections.map((d, i) => h('div', { key: i, className: 'flex items-start gap-3 bg-neutral-800/30 rounded-xl p-3' },
          h(AlertIcon, { size: 16, className: 'text-yellow-400 shrink-0 mt-0.5' }),
          h('span', { className: 'text-sm text-neutral-300' }, d)
        ))
      )
    )
  );
}

// ============================================================
// Page: Device Comparison
// ============================================================
function DeviceCompPage() {
  const [view, setView] = useState('ranking');
  const [search, setSearch] = useState('');
  const [brand, setBrand] = useState('');
  const [d1, setD1] = useState('');
  const [d2, setD2] = useState('');

  const brands = [...new Set(DEVICE_DB.map(d => d.brand))].sort();
  const devices = brand ? DEVICE_DB.filter(d => d.brand === brand) : search ? DEVICE_DB.filter(d => (d.brand+' '+d.model).toLowerCase().includes(search.toLowerCase())) : DEVICE_DB;
  const dev1 = DEVICE_DB.find(d => d.model === d1);
  const dev2 = DEVICE_DB.find(d => d.model === d2);

  const updateColor = u => u === 'Monthly' ? 'bg-green-500/20 text-green-400 border-green-500/30' : u === 'Quarterly' ? 'bg-blue-500/20 text-blue-400 border-blue-500/30' : 'bg-red-500/20 text-red-400 border-red-500/30';

  return h('div', { className: 'space-y-6 max-w-5xl mx-auto' },
    h('div', { className: 'flex gap-3' },
      h('button', { onClick: () => setView('ranking'), className: `flex-1 py-3 rounded-xl font-medium transition-all ${view === 'ranking' ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-neutral-800 text-neutral-400 border border-neutral-700'}` }, 'Security Rankings'),
      h('button', { onClick: () => setView('compare'), className: `flex-1 py-3 rounded-xl font-medium transition-all ${view === 'compare' ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-neutral-800 text-neutral-400 border border-neutral-700'}` }, 'Compare Devices')
    ),
    view === 'ranking'
      ? h('div', { className: 'space-y-4' },
          h('div', { className: 'flex flex-col md:flex-row gap-4' },
            h('input', { type: 'text', placeholder: 'Search devices...', value: search, onChange: e => { setSearch(e.target.value); setBrand(''); }, className: 'flex-1 bg-neutral-900/50 border border-neutral-800 rounded-xl px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-green-500/50' }),
            h('select', { value: brand, onChange: e => { setBrand(e.target.value); setSearch(''); }, className: 'bg-neutral-900/50 border border-neutral-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-green-500/50' },
              h('option', { value: '' }, 'All Brands'),
              ...brands.map(b => h('option', { key: b, value: b }, b))
            )
          ),
          h('div', { className: 'space-y-3' },
            ...devices.map((d, i) => {
              const rank = DEVICE_DB.indexOf(d) + 1;
              return h('div', { key: d.model, className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5 flex items-center gap-5 hover:border-neutral-700 transition-all' },
                h('div', { className: 'w-10 text-center' },
                  rank <= 3 ? h(TrophyIcon, { size: 24, className: rank === 1 ? 'text-yellow-400' : rank === 2 ? 'text-neutral-300' : 'text-amber-600' }) : h('span', { className: 'text-lg font-bold text-neutral-500' }, '#'+rank)
                ),
                h('div', { className: 'flex-1 min-w-0' },
                  h('div', { className: 'flex items-center gap-2 mb-1' }, h('span', { className: 'font-semibold text-white' }, d.brand), h('span', { className: 'text-neutral-400' }, d.model)),
                  h('div', { className: 'flex flex-wrap gap-2 text-xs' },
                    h('span', { className: 'text-neutral-500' }, 'OS ' + d.os),
                    h('span', { className: 'text-neutral-600' }, '|'),
                    h('span', { className: 'text-neutral-500' }, d.vulns + ' CVEs'),
                    h('span', { className: 'text-neutral-600' }, '|'),
                    h('span', { className: `px-2 py-0.5 rounded-full border ${updateColor(d.updates)}` }, d.updates),
                    h('span', { className: 'text-neutral-600' }, '|'),
                    h('span', { className: 'text-neutral-500' }, 'Until ' + d.until)
                  )
                ),
                h(ScoreRing, { score: d.score, grade: getGrade(d.score), size: 60 })
              );
            })
          )
        )
      : h('div', { className: 'space-y-4' },
          h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
            h('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Select Devices'),
            h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
              h('select', { value: d1, onChange: e => setD1(e.target.value), className: 'bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-green-500/50' },
                h('option', { value: '' }, 'Device 1'),
                ...DEVICE_DB.map(d => h('option', { key: 'a'+d.model, value: d.model }, d.brand+' '+d.model))
              ),
              h('select', { value: d2, onChange: e => setD2(e.target.value), className: 'bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-green-500/50' },
                h('option', { value: '' }, 'Device 2'),
                ...DEVICE_DB.map(d => h('option', { key: 'b'+d.model, value: d.model }, d.brand+' '+d.model))
              )
            )
          ),
          dev1 && dev2 && h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6 animate-slide-up' },
            h('div', { className: 'flex items-center justify-center gap-8 mb-6' },
              h('div', { className: 'text-center' }, h(ScoreRing, { score: dev1.score, grade: getGrade(dev1.score), size: 120 }), h('p', { className: 'mt-2 font-semibold text-white' }, dev1.brand+' '+dev1.model)),
              h('p', { className: 'text-neutral-500' }, 'VS'),
              h('div', { className: 'text-center' }, h(ScoreRing, { score: dev2.score, grade: getGrade(dev2.score), size: 120 }), h('p', { className: 'mt-2 font-semibold text-white' }, dev2.brand+' '+dev2.model))
            ),
            h('p', { className: 'text-center text-lg font-bold text-green-400 mb-4' }, dev1.score > dev2.score ? dev1.model+' wins' : dev2.score > dev1.score ? dev2.model+' wins' : 'Tie!'),
            h('div', { className: 'space-y-2' },
              ...[
                ['Score', dev1.score+'/100', dev2.score+'/100', dev1.score > dev2.score ? 1 : dev1.score < dev2.score ? 2 : 0],
                ['OS', dev1.os, dev2.os, 0],
                ['CVEs', dev1.vulns+'', dev2.vulns+'', dev1.vulns < dev2.vulns ? 1 : dev1.vulns > dev2.vulns ? 2 : 0],
                ['Updates', dev1.updates, dev2.updates, 0],
                ['Support', dev1.until, dev2.until, dev1.until > dev2.until ? 1 : dev1.until < dev2.until ? 2 : 0]
              ].map(([cat, v1, v2, w]) => h('div', { key: cat, className: 'bg-neutral-800/50 rounded-xl p-4 flex items-center gap-4' },
                h('span', { className: 'text-sm text-neutral-400 w-24' }, cat),
                h('div', { className: `flex-1 text-center py-1 rounded-lg ${w === 1 ? 'bg-green-500/10 text-green-400 font-semibold' : 'text-neutral-400'}` }, v1),
                h('div', { className: `flex-1 text-center py-1 rounded-lg ${w === 2 ? 'bg-green-500/10 text-green-400 font-semibold' : 'text-neutral-400'}` }, v2)
              ))
            )
          )
        )
  );
}

// ============================================================
// Page: Wi-Fi Analyzer
// ============================================================
function WiFiPage() {
  const [ssid, setSsid] = useState('');
  const [enc, setEnc] = useState('WPA2');
  const [pub, setPub] = useState(false);
  const [result, setResult] = useState(null);

  const isSecure = typeof window !== 'undefined' && window.location.protocol === 'https:';

  function analyze() {
    if (!ssid.trim()) return;
    const risks = [];
    let score = 100;
    if (enc === 'OPEN') { risks.push('No encryption - all traffic visible'); score -= 50; }
    if (enc === 'WEP') { risks.push('WEP is broken and crackable in minutes'); score -= 40; }
    if (enc === 'WPA') { risks.push('WPA has known vulnerabilities - upgrade to WPA2/WPA3'); score -= 20; }
    if (pub) { risks.push('Public networks are vulnerable to MITM attacks'); score -= 20; }
    const lower = ssid.toLowerCase();
    if (lower.includes('free') || lower.includes('guest')) { risks.push('Network name suggests public access'); score -= 10; }
    if (['linksys','netgear','default','dlink'].some(s => lower.includes(s))) { risks.push('Default SSID - possible evil twin'); score -= 5; }
    const recs = [];
    if (score < 80) recs.push('Use a VPN on this network');
    if (enc !== 'WPA3') recs.push('Upgrade router to WPA3 encryption');
    if (pub) { recs.push('Disable file sharing'); recs.push('Use HTTPS-only mode'); }
    recs.push('Change Wi-Fi password regularly');
    recs.push('Update router firmware');
    setResult({ ssid, enc, pub, score: Math.max(0, score), risks, recs });
  }

  return h('div', { className: 'space-y-6 max-w-4xl mx-auto' },
    h('div', { className: `bg-neutral-900/50 rounded-2xl border p-6 ${isSecure ? 'border-green-500/30' : 'border-red-500/30'}` },
      h('div', { className: 'flex items-center gap-4' },
        isSecure
          ? h('div', { className: 'w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center' }, h(LockIcon, { size: 24, className: 'text-green-400' }))
          : h('div', { className: 'w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center' }, h(AlertIcon, { size: 24, className: 'text-red-400' })),
        h('div', null, h('h3', { className: 'text-lg font-semibold text-white' }, 'Current Connection'), h('p', { className: 'text-neutral-400' }, isSecure ? 'Secure HTTPS connection' : 'Insecure HTTP connection'))
      )
    ),
    h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
      h('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Analyze Wi-Fi Network'),
      h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4 mb-4' },
        h('div', null, h('label', { className: 'text-sm text-neutral-400 block mb-2' }, 'Network Name (SSID)'),
          h('input', { type: 'text', value: ssid, onChange: e => setSsid(e.target.value), onKeyDown: e => e.key === 'Enter' && analyze(), placeholder: 'Enter Wi-Fi name', className: 'w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-green-500/50' })
        ),
        h('div', null, h('label', { className: 'text-sm text-neutral-400 block mb-2' }, 'Encryption'),
          h('select', { value: enc, onChange: e => setEnc(e.target.value), className: 'w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-green-500/50' },
            ...['WPA3','WPA2','WPA','WEP','OPEN'].map(e => h('option', { key: e, value: e }, e + (e === 'WPA3' ? ' (Best)' : e === 'OPEN' ? ' (No Encryption)' : '')))
          )
        )
      ),
      h('div', { className: 'flex items-center justify-between' },
        h('label', { className: 'flex items-center gap-3 cursor-pointer' },
          h('input', { type: 'checkbox', checked: pub, onChange: e => setPub(e.target.checked), className: 'w-4 h-4 rounded' }),
          h('span', { className: 'text-sm text-neutral-400' }, 'Public/shared network')
        ),
        h('button', { onClick: analyze, disabled: !ssid.trim(), className: 'flex items-center gap-2 bg-green-600 hover:bg-green-500 disabled:bg-neutral-700 text-white font-semibold py-3 px-6 rounded-xl transition-all' }, h(RadioIcon, { size: 18 }), 'Analyze')
      )
    ),
    result && h('div', { className: 'animate-slide-up space-y-4' },
      h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
        h('div', { className: 'flex flex-col md:flex-row items-center gap-8' },
          h(ScoreRing, { score: result.score, grade: getGrade(result.score), size: 140 }),
          h('div', { className: 'flex-1' },
            h('h3', { className: 'text-xl font-bold text-white mb-2' }, result.ssid),
            h('div', { className: 'grid grid-cols-2 gap-3' },
              h('div', { className: 'bg-neutral-800/50 rounded-xl p-3' }, h('p', { className: 'text-xs text-neutral-500' }, 'Encryption'), h('p', { className: 'font-semibold text-white' }, result.enc)),
              h('div', { className: 'bg-neutral-800/50 rounded-xl p-3' }, h('p', { className: 'text-xs text-neutral-500' }, 'Type'), h('p', { className: 'font-semibold text-white' }, result.pub ? 'Public' : 'Private'))
            )
          )
        )
      ),
      result.risks.length > 0 && h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
        h('h4', { className: 'text-lg font-semibold text-white mb-4' }, 'Risks Detected'),
        h('div', { className: 'space-y-3' }, ...result.risks.map((r, i) => h('div', { key: i, className: 'flex items-start gap-3 bg-red-500/5 rounded-xl p-4 border border-red-500/10' }, h(AlertIcon, { size: 18, className: 'text-red-400 shrink-0 mt-0.5' }), h('span', { className: 'text-sm text-neutral-300' }, r))))
      ),
      h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
        h('h4', { className: 'text-lg font-semibold text-white mb-4' }, 'Recommendations'),
        h('div', { className: 'space-y-3' }, ...result.recs.map((r, i) => h('div', { key: i, className: 'flex items-start gap-3 bg-green-500/5 rounded-xl p-4 border border-green-500/10' }, h(CheckIcon, { size: 18, className: 'text-green-400 shrink-0 mt-0.5' }), h('span', { className: 'text-sm text-neutral-300' }, r))))
      )
    )
  );
}

// ============================================================
// Page: OSINT Checker
// ============================================================
function OSINTPage() {
  const [query, setQuery] = useState('');
  const [result, setResult] = useState(null);
  const [searching, setSearching] = useState(false);

  async function check() {
    if (!query.trim()) return;
    setSearching(true); setResult(null);
    // Simulate breach check (real API requires HIBP key)
    await new Promise(r => setTimeout(r, 1500));
    const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(query);
    const isIP = /^(\d{1,3}\.){3}\d{1,3}$/.test(query);
    const type = isEmail ? 'EMAIL' : isIP ? 'IP' : 'USERNAME';
    // Demo result
    setResult({
      query: query.trim(), type, breaches: 0, risk: 'NONE',
      message: 'OSINT check completed. In production, this would query Have I Been Pwned, AbuseIPDB, and other databases. Configure API keys for live results.'
    });
    setSearching(false);
  }

  const typeIcons = { EMAIL: h(MailIcon, { size: 20 }), PHONE: h(PhoneIcon, { size: 20 }), USERNAME: h(UserIcon, { size: 20 }), IP: h(GlobeIcon, { size: 20 }) };

  return h('div', { className: 'space-y-6 max-w-4xl mx-auto' },
    h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
      h('h3', { className: 'text-lg font-semibold text-white mb-2' }, 'Data Breach & Leak Checker'),
      h('p', { className: 'text-sm text-neutral-500 mb-4' }, 'Check if your email, phone, username, or IP has been exposed'),
      h('div', { className: 'flex gap-3' },
        h('div', { className: 'flex-1 relative' },
          h('div', { className: 'absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500' }, h(SearchIcon, { size: 18 })),
          h('input', { type: 'text', value: query, onChange: e => setQuery(e.target.value), onKeyDown: e => e.key === 'Enter' && check(), placeholder: 'Enter email, username, or IP...', className: 'w-full bg-neutral-800 border border-neutral-700 rounded-xl pl-11 pr-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-green-500/50' })
        ),
        h('button', { onClick: check, disabled: searching || !query.trim(), className: 'flex items-center gap-2 bg-green-600 hover:bg-green-500 disabled:bg-neutral-700 text-white font-semibold py-3 px-6 rounded-xl transition-all' },
          searching ? h(SearchIcon, { size: 18, className: 'animate-spin' }) : h(SearchIcon, { size: 18 }), 'Check')
      )
    ),
    result && h('div', { className: `bg-neutral-900/50 rounded-2xl border p-6 animate-slide-up ${result.risk === 'NONE' ? 'border-green-500/30' : 'border-red-500/30'}` },
      h('div', { className: 'flex items-center gap-4 mb-4' },
        h('div', { className: 'w-14 h-14 bg-green-500/20 rounded-2xl flex items-center justify-center' }, h(CheckIcon, { size: 32, className: 'text-green-400' })),
        h('div', null,
          h('h3', { className: 'text-xl font-bold text-white' }, 'Check Complete'),
          h('p', { className: 'text-neutral-400 flex items-center gap-2' }, typeIcons[result.type], result.query)
        )
      ),
      h('div', { className: 'grid grid-cols-3 gap-4 mb-4' },
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4 text-center' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'Risk Level'), h('p', { className: 'text-lg font-bold text-green-400' }, result.risk)),
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4 text-center' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'Breaches'), h('p', { className: 'text-lg font-bold text-white' }, result.breaches)),
        h('div', { className: 'bg-neutral-800/50 rounded-xl p-4 text-center' }, h('p', { className: 'text-xs text-neutral-500 mb-1' }, 'Type'), h('p', { className: 'text-lg font-bold text-white' }, result.type))
      ),
      h('div', { className: 'bg-blue-500/5 rounded-xl p-4 border border-blue-500/10' },
        h('p', { className: 'text-sm text-blue-300' }, result.message)
      )
    )
  );
}

// ============================================================
// Page: AI Assistant
// ============================================================
function AIAssistantPage() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const endRef = useRef(null);

  useEffect(() => { endRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

  const prompts = [
    'What are the most critical Android vulnerabilities right now?',
    'How do I protect my phone from stalkerware?',
    'What permissions should I never grant to apps?',
    'How can I tell if a URL is a phishing attempt?',
    'Is my Wi-Fi network secure enough?',
    'What should I do if my data was in a breach?',
  ];

  async function send(text) {
    const content = text || input.trim();
    if (!content || loading) return;
    const userMsg = { role: 'user', content, time: new Date().toISOString() };
    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setLoading(true);
    // Simulate AI response (would use Gemini API with key)
    await new Promise(r => setTimeout(r, 1000));
    const responses = {
      'vulnerabilities': 'The most critical Android vulnerabilities currently include CVE-2025-27363 (FreeType out-of-bounds write, CVSS 8.1), CVE-2024-53104 (USB Video Class exploit, CVSS 7.8), and CVE-2024-53197 (ALSA USB audio exploit). All have active exploits in the wild. Update your security patches immediately.',
      'stalkerware': 'To protect against stalkerware: 1) Regularly review installed apps for unfamiliar ones, 2) Check for apps with excessive permissions (camera+mic+location+contacts), 3) Look for apps disguised as "System Service" or with no icon, 4) Use this scanner\'s Permission Audit tool, 5) Keep your device updated and use strong authentication.',
      'permissions': 'Never blindly grant: Camera, Microphone, Location (especially "Always"), Contacts, SMS, Phone call logs, and Clipboard access. Only grant these to apps that genuinely need them for their core function. Review permissions regularly in Settings > Apps.',
      'phishing': 'Look for: 1) Misspelled domain names (g00gle.com), 2) IP addresses instead of domains, 3) Excessive subdomains, 4) Missing HTTPS, 5) Recently registered domains, 6) Urgent language pressuring immediate action. Use our URL Scanner to check any suspicious link.',
      'wifi': 'Check: 1) Use WPA3 or at minimum WPA2 encryption, 2) Avoid open/WEP networks, 3) Use VPN on public Wi-Fi, 4) Verify network name (avoid evil twins), 5) Disable auto-connect to open networks, 6) Update router firmware regularly.',
      'breach': 'If your data was breached: 1) Change passwords immediately, 2) Enable 2FA everywhere, 3) Monitor accounts for unauthorized activity, 4) Check credit reports, 5) Use unique passwords via a password manager, 6) Consider identity monitoring services.',
    };
    const key = Object.keys(responses).find(k => content.toLowerCase().includes(k));
    const reply = key ? responses[key] : 'I can help with mobile security questions. Try asking about vulnerabilities, permissions, phishing, Wi-Fi security, stalkerware, or data breaches. For AI-powered analysis, configure a Gemini API key in the settings.';
    setMessages(prev => [...prev, { role: 'assistant', content: reply, time: new Date().toISOString() }]);
    setLoading(false);
  }

  if (messages.length === 0) return h('div', { className: 'max-w-4xl mx-auto flex flex-col', style: { height: 'calc(100vh - 160px)' } },
    h('div', { className: 'flex-1 flex flex-col items-center justify-center' },
      h('div', { className: 'w-20 h-20 bg-green-500/20 rounded-3xl flex items-center justify-center mb-6' }, h(SparklesIcon, { size: 40, className: 'text-green-400' })),
      h('h2', { className: 'text-2xl font-bold text-white mb-2' }, 'ExploitGuard AI'),
      h('p', { className: 'text-neutral-400 mb-8 text-center max-w-md' }, 'Your personal security advisor. Ask about vulnerabilities, permissions, phishing protection, and more.'),
      h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-2xl' },
        ...prompts.map(p => h('button', { key: p, onClick: () => send(p), className: 'text-left p-4 bg-neutral-900/50 rounded-xl border border-neutral-800 hover:border-green-500/30 hover:bg-neutral-800/50 transition-all text-sm text-neutral-300' }, p))
      )
    ),
    h('div', { className: 'border-t border-neutral-800 pt-4 mt-auto' },
      h('div', { className: 'flex gap-3' },
        h('input', { type: 'text', value: input, onChange: e => setInput(e.target.value), onKeyDown: e => e.key === 'Enter' && send(), placeholder: 'Ask about security...', className: 'flex-1 bg-neutral-900/50 border border-neutral-800 rounded-xl px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-green-500/50' }),
        h('button', { onClick: () => send(), disabled: !input.trim(), className: 'p-3 text-green-400 hover:text-green-300 disabled:text-neutral-600 transition-colors' }, h(SendIcon, { size: 18 }))
      )
    )
  );

  return h('div', { className: 'max-w-4xl mx-auto flex flex-col', style: { height: 'calc(100vh - 160px)' } },
    h('div', { className: 'flex-1 overflow-y-auto space-y-4 pb-4 scrollbar-hide' },
      ...messages.map((msg, i) => h('div', { key: i, className: `flex gap-3 animate-fade-in ${msg.role === 'user' ? 'justify-end' : ''}` },
        msg.role === 'assistant' && h('div', { className: 'w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center shrink-0' }, h(BotIcon, { size: 18, className: 'text-green-400' })),
        h('div', { className: `max-w-[80%] rounded-2xl p-4 ${msg.role === 'user' ? 'bg-green-600/20 border border-green-500/20 text-white' : 'bg-neutral-900/50 border border-neutral-800 text-neutral-200'}` },
          h('p', { className: 'text-sm whitespace-pre-wrap' }, msg.content),
          h('p', { className: 'text-xs text-neutral-500 mt-2' }, new Date(msg.time).toLocaleTimeString())
        ),
        msg.role === 'user' && h('div', { className: 'w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center shrink-0' }, h(UserIcon, { size: 18, className: 'text-blue-400' }))
      )),
      loading && h('div', { className: 'flex gap-3 animate-fade-in' },
        h('div', { className: 'w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center shrink-0' }, h(BotIcon, { size: 18, className: 'text-green-400' })),
        h('div', { className: 'bg-neutral-900/50 border border-neutral-800 rounded-2xl p-4' },
          h('div', { className: 'flex gap-1' },
            h('div', { className: 'w-2 h-2 bg-green-400 rounded-full animate-bounce' }),
            h('div', { className: 'w-2 h-2 bg-green-400 rounded-full animate-bounce', style: { animationDelay: '0.1s' } }),
            h('div', { className: 'w-2 h-2 bg-green-400 rounded-full animate-bounce', style: { animationDelay: '0.2s' } })
          )
        )
      ),
      h('div', { ref: endRef })
    ),
    h('div', { className: 'border-t border-neutral-800 pt-4 mt-auto' },
      h('div', { className: 'flex gap-3' },
        h('button', { onClick: () => setMessages([]), className: 'p-3 bg-neutral-800 hover:bg-neutral-700 rounded-xl text-neutral-400 transition-colors' }, h(TrashIcon, { size: 20 })),
        h('input', { type: 'text', value: input, onChange: e => setInput(e.target.value), onKeyDown: e => e.key === 'Enter' && !e.shiftKey && send(), placeholder: 'Ask about security...', disabled: loading, className: 'flex-1 bg-neutral-900/50 border border-neutral-800 rounded-xl px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-green-500/50 disabled:opacity-50' }),
        h('button', { onClick: () => send(), disabled: loading || !input.trim(), className: 'p-3 text-green-400 hover:text-green-300 disabled:text-neutral-600 transition-colors' }, h(SendIcon, { size: 18 }))
      )
    )
  );
}

// ============================================================
// Page: Security History
// ============================================================
function HistoryPage() {
  const history = [
    { date: '2026-02-28', score: 78, events: ['Full scan completed', 'CVE-2024-53104 detected'] },
    { date: '2026-02-25', score: 72, events: ['New app installed', 'Camera permission granted'] },
    { date: '2026-02-20', score: 85, events: ['Security patch applied', 'CVE-2024-43093 resolved'] },
    { date: '2026-02-15', score: 65, events: ['Suspicious app detected', 'Malicious app removed'] },
    { date: '2026-02-10', score: 60, events: ['Scheduled scan completed'] },
    { date: '2026-02-05', score: 55, events: ['USB debugging enabled'] },
  ];
  const [selected, setSelected] = useState(null);
  const latest = history[0].score;
  const oldest = history[history.length-1].score;
  const trend = latest - oldest;

  return h('div', { className: 'space-y-6 max-w-5xl mx-auto' },
    h('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
      h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5' }, h('p', { className: 'text-xs text-neutral-500 mb-2' }, 'Current'), h('p', { className: 'text-3xl font-bold text-white' }, latest)),
      h('div', { className: `rounded-2xl border p-5 ${trend >= 0 ? 'bg-green-500/10 border-green-500/20' : 'bg-red-500/10 border-red-500/20'}` },
        h('p', { className: 'text-xs text-neutral-500 mb-2' }, 'Trend'),
        h('div', { className: 'flex items-center gap-2' },
          trend >= 0 ? h(TrendUpIcon, { size: 20, className: 'text-green-400' }) : h(TrendDownIcon, { size: 20, className: 'text-red-400' }),
          h('span', { className: `text-3xl font-bold ${trend >= 0 ? 'text-green-400' : 'text-red-400'}` }, (trend >= 0 ? '+' : '') + trend)
        )
      ),
      h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5' }, h('p', { className: 'text-xs text-neutral-500 mb-2' }, 'Peak'), h('p', { className: 'text-3xl font-bold text-green-400' }, Math.max(...history.map(h=>h.score)))),
      h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5' }, h('p', { className: 'text-xs text-neutral-500 mb-2' }, 'Low'), h('p', { className: 'text-3xl font-bold text-red-400' }, Math.min(...history.map(h=>h.score))))
    ),
    h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6' },
      h('h3', { className: 'text-lg font-semibold text-white mb-6' }, 'Score Timeline'),
      h('div', { className: 'flex items-end justify-between gap-2 h-40' },
        ...[...history].reverse().map((entry, i) => h('button', { key: i, onClick: () => setSelected(entry), className: 'flex-1 flex flex-col items-center gap-2 group' },
          h('span', { className: 'text-xs text-neutral-500 opacity-0 group-hover:opacity-100 transition-opacity' }, entry.score),
          h('div', { className: `w-full rounded-t-lg transition-all group-hover:opacity-80 ${entry.score >= 85 ? 'bg-green-500' : entry.score >= 70 ? 'bg-green-600' : entry.score >= 55 ? 'bg-yellow-500' : 'bg-red-500'} ${selected?.date === entry.date ? 'ring-2 ring-white/30' : ''}`, style: { height: entry.score + '%' } }),
          h('span', { className: 'text-xs text-neutral-600 truncate w-full text-center' }, new Date(entry.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }))
        ))
      )
    ),
    selected && h('div', { className: 'bg-neutral-900/50 rounded-2xl border border-green-500/20 p-6 animate-fade-in' },
      h('div', { className: 'flex items-center justify-between mb-4' },
        h('div', null, h('h4', { className: 'text-lg font-semibold text-white' }, new Date(selected.date).toLocaleDateString('en-GB', { weekday: 'long', month: 'long', day: 'numeric' })), h('p', { className: 'text-sm text-neutral-500' }, selected.events.length + ' events')),
        h(ScoreRing, { score: selected.score, grade: getGrade(selected.score), size: 80 })
      ),
      h('div', { className: 'space-y-2' },
        ...selected.events.map((e, i) => h('div', { key: i, className: 'flex items-start gap-3 bg-neutral-800/50 rounded-xl p-3' },
          h(ShieldIcon, { size: 16, className: 'text-blue-400 mt-0.5' }),
          h('span', { className: 'text-sm text-white' }, e)
        ))
      )
    )
  );
}

// ============================================================
// Main App with Sidebar Navigation
// ============================================================
const NAV = [
  { id: 'dashboard', label: 'Dashboard', icon: ShieldIcon, desc: 'Security overview' },
  { id: 'vulnerabilities', label: 'Vulnerability Scanner', icon: ScanIcon, desc: 'CVE & exploit detection' },
  { id: 'url-scanner', label: 'URL Scanner', icon: GlobeIcon, desc: 'Phishing & scam protection' },
  { id: 'permissions', label: 'Permission Audit', icon: LockIcon, desc: 'App permission manager' },
  { id: 'file-scanner', label: 'File Scanner', icon: FileIcon, desc: 'Malware file checker' },
  { id: 'devices', label: 'Device Comparison', icon: SmartphoneIcon, desc: 'Compare device security' },
  { id: 'wifi', label: 'Wi-Fi Analyzer', icon: WifiIcon, desc: 'Network security audit' },
  { id: 'osint', label: 'OSINT Checker', icon: AlertIcon, desc: 'Data breach lookup' },
  { id: 'ai-assistant', label: 'AI Assistant', icon: MessageIcon, desc: 'Security advisor' },
  { id: 'history', label: 'Security History', icon: BarChartIcon, desc: 'Score tracking' },
];

function App() {
  const [page, setPage] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(false);

  const pages = {
    dashboard: () => h(DashboardPage, { onNav: setPage }),
    vulnerabilities: VulnScannerPage,
    'url-scanner': URLScannerPage,
    permissions: PermissionAuditPage,
    'file-scanner': FileScannerPage,
    devices: DeviceCompPage,
    wifi: WiFiPage,
    osint: OSINTPage,
    'ai-assistant': AIAssistantPage,
    history: HistoryPage,
  };

  const PageComponent = pages[page] || DashboardPage;
  const currentNav = NAV.find(n => n.id === page);

  // Expose API for Claude
  useEffect(() => {
    window.__EXPLOIT_GUARD_API__ = { scanDevice, scanURL, KNOWN_CVES, DEVICE_DB, auditPermissions, version: '1.0.0' };
    return () => { delete window.__EXPLOIT_GUARD_API__; };
  }, []);

  return h('div', { className: 'min-h-screen bg-[#0a0a0a] text-neutral-100 flex font-sans' },
    // Mobile overlay
    sidebarOpen && h('div', { className: 'fixed inset-0 bg-black/60 z-40 lg:hidden', onClick: () => setSidebarOpen(false) }),

    // Sidebar
    h('aside', { className: `fixed lg:sticky top-0 left-0 z-50 h-screen w-72 bg-neutral-900/95 backdrop-blur-xl border-r border-neutral-800 flex flex-col transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}` },
      // Logo
      h('div', { className: 'p-6 border-b border-neutral-800' },
        h('div', { className: 'flex items-center gap-3' },
          h('div', { className: 'w-10 h-10 bg-green-500/20 rounded-xl flex items-center justify-center' }, h(ShieldIcon, { size: 24, className: 'text-green-400' })),
          h('div', null,
            h('h1', { className: 'text-lg font-bold text-white' }, 'ExploitGuard'),
            h('p', { className: 'text-xs text-neutral-500' }, 'Security Suite v1.0')
          )
        )
      ),
      // Nav
      h('nav', { className: 'flex-1 overflow-y-auto py-4 px-3 scrollbar-hide' },
        ...NAV.map(item => h('button', {
          key: item.id,
          onClick: () => { setPage(item.id); setSidebarOpen(false); },
          className: `w-full flex items-center gap-3 px-4 py-3 rounded-xl mb-1 text-left transition-all ${page === item.id ? 'bg-green-500/15 text-green-400 border border-green-500/20' : 'text-neutral-400 hover:bg-neutral-800 hover:text-neutral-200 border border-transparent'}`
        },
          h(item.icon, { size: 20 }),
          h('div', { className: 'flex-1 min-w-0' },
            h('div', { className: 'text-sm font-medium truncate' }, item.label),
            h('div', { className: 'text-xs text-neutral-500 truncate' }, item.desc)
          ),
          page === item.id && h(ChevronRightIcon, { size: 16, className: 'text-green-400/60' })
        ))
      ),
      // Footer
      h('div', { className: 'p-4 border-t border-neutral-800' },
        h('div', { className: 'flex items-center gap-2 text-xs text-neutral-500' },
          h('div', { className: 'w-2 h-2 bg-green-500 rounded-full animate-pulse' }),
          h('span', null, 'All systems operational')
        )
      )
    ),

    // Main content
    h('main', { className: 'flex-1 min-w-0' },
      // Top bar
      h('header', { className: 'sticky top-0 z-30 bg-[#0a0a0a]/80 backdrop-blur-xl border-b border-neutral-800 px-4 lg:px-8 py-4 flex items-center gap-4' },
        h('button', { onClick: () => setSidebarOpen(true), className: 'lg:hidden text-neutral-400 hover:text-white transition-colors' }, h(MenuIcon, { size: 24 })),
        h('div', { className: 'flex-1' },
          h('h2', { className: 'text-lg font-semibold text-white' }, currentNav?.label || 'Dashboard'),
          h('p', { className: 'text-sm text-neutral-500' }, currentNav?.desc || 'Security overview')
        )
      ),
      // Page
      h('div', { className: 'p-4 lg:p-8 animate-fade-in' }, h(PageComponent))
    )
  );
}

// Mount
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(h(App));
