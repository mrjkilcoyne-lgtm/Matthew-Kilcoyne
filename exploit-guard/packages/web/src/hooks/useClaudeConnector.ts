/**
 * Claude Code / Claude Chat connector hook
 *
 * Provides an interface for Claude tools (Claude Code, Claude Chat, Claude Cowork)
 * to interact with the deployed ExploitGuard web application.
 *
 * When deployed on Netlify, Claude can:
 * 1. Read security scan results via the exposed API
 * 2. Trigger vulnerability scans programmatically
 * 3. Query the security database
 * 4. Interact with the AI assistant context
 *
 * This is implemented as a browser-side hook that exposes functions
 * on the window object for external tool access.
 */

import { useState, useEffect } from 'react';
import { scanDeviceVulnerabilities, getKnownCVEs, fetchNVDCves } from '@shared/services/cveService';
import { scanURL } from '@shared/services/urlScanner';
import { autoOSINTCheck } from '@shared/services/osintService';
import { auditWebPermissions } from '@shared/services/permissionAuditor';
import { getAllDevices, compareDevices } from '@shared/services/deviceComparison';

interface ClaudeAPI {
  scanVulnerabilities: (osVersion: string, patchLevel: string) => ReturnType<typeof scanDeviceVulnerabilities>;
  scanURL: typeof scanURL;
  checkOSINT: typeof autoOSINTCheck;
  getKnownCVEs: typeof getKnownCVEs;
  fetchLatestCVEs: typeof fetchNVDCves;
  auditPermissions: typeof auditWebPermissions;
  getAllDevices: typeof getAllDevices;
  compareDevices: typeof compareDevices;
  getVersion: () => string;
}

export function useClaudeConnector() {
  const [connected, setConnected] = useState(false);

  useEffect(() => {
    // Expose API on window for Claude tool access
    const api: ClaudeAPI = {
      scanVulnerabilities: (osVersion: string, patchLevel: string) =>
        scanDeviceVulnerabilities(osVersion, patchLevel),
      scanURL,
      checkOSINT: autoOSINTCheck,
      getKnownCVEs,
      fetchLatestCVEs: fetchNVDCves,
      auditPermissions: auditWebPermissions,
      getAllDevices,
      compareDevices,
      getVersion: () => '1.0.0',
    };

    (window as any).__EXPLOIT_GUARD_API__ = api;
    setConnected(true);

    // Also expose via postMessage for iframe/extension access
    const handleMessage = async (event: MessageEvent) => {
      if (event.data?.type !== 'EXPLOIT_GUARD_REQUEST') return;

      const { method, params, requestId } = event.data;
      try {
        const fn = (api as any)[method];
        if (typeof fn !== 'function') {
          throw new Error(`Unknown method: ${method}`);
        }
        const result = await fn(...(params || []));
        window.parent.postMessage({
          type: 'EXPLOIT_GUARD_RESPONSE',
          requestId,
          result,
        }, '*');
      } catch (error: any) {
        window.parent.postMessage({
          type: 'EXPLOIT_GUARD_RESPONSE',
          requestId,
          error: error.message,
        }, '*');
      }
    };

    window.addEventListener('message', handleMessage);

    return () => {
      delete (window as any).__EXPLOIT_GUARD_API__;
      window.removeEventListener('message', handleMessage);
      setConnected(false);
    };
  }, []);

  return { connected };
}
