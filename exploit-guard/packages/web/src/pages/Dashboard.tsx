import React, { useState, useEffect } from 'react';
import {
  Shield, AlertTriangle, Scan, Lock, Wifi, Globe,
  Bug, Smartphone, FileSearch, TrendingUp,
} from 'lucide-react';
import ScoreRing from '../components/ScoreRing';
import StatCard from '../components/StatCard';
import SeverityBadge from '../components/SeverityBadge';
import {
  calculateSecurityScore,
  getGradeDescription,
} from '@shared/services/securityScoring';
import { scanDeviceVulnerabilities } from '@shared/services/cveService';
import { auditWebPermissions } from '@shared/services/permissionAuditor';
import type { SecurityScore, VulnerabilityScanResult } from '@shared/models/types';

interface DashboardProps {
  onNavigate: (page: string) => void;
}

export default function Dashboard({ onNavigate }: DashboardProps) {
  const [score, setScore] = useState<SecurityScore | null>(null);
  const [vulnScan, setVulnScan] = useState<VulnerabilityScanResult | null>(null);
  const [permissionCount, setPermissionCount] = useState(0);
  const [scanning, setScanning] = useState(true);

  useEffect(() => {
    runInitialScan();
  }, []);

  async function runInitialScan() {
    setScanning(true);

    // Detect device info from user agent
    const ua = navigator.userAgent;
    const isAndroid = /android/i.test(ua);
    const androidVersion = ua.match(/Android\s([\d.]+)/)?.[1] || '14';
    const osVersion = isAndroid ? androidVersion : 'Web Browser';
    const patchLevel = '2025-01-01'; // Default for web context

    // Run vulnerability scan
    const vulns = scanDeviceVulnerabilities(osVersion, patchLevel, getDeviceModel(ua));
    setVulnScan(vulns);

    // Audit permissions
    const perms = await auditWebPermissions();
    const grantedDangerous = perms.filter((p) => p.dangerLevel === 'DANGEROUS' && p.granted).length;
    setPermissionCount(grantedDangerous);

    // Calculate security score
    const secScore = calculateSecurityScore({
      osVersion,
      patchLevel,
      vulnerabilityCount: vulns.totalFound,
      dangerousPermissions: grantedDangerous,
      stalkerwareCount: 0,
      openPorts: 0,
      isEncrypted: true,
      hasLockScreen: true,
      isRooted: false,
      debuggingEnabled: false,
    });
    setScore(secScore);
    setScanning(false);
  }

  function getDeviceModel(ua: string): string {
    const match = ua.match(/\(([^)]+)\)/);
    if (match) {
      const parts = match[1].split(';');
      return parts[parts.length - 1]?.trim().split(' Build')[0] || 'Unknown Device';
    }
    return navigator.platform || 'Unknown Device';
  }

  if (scanning) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[60vh] gap-6">
        <div className="relative">
          <div className="w-24 h-24 bg-green-500/10 rounded-full flex items-center justify-center animate-scan-pulse">
            <Shield size={48} className="text-green-400" />
          </div>
          <div className="absolute inset-0 rounded-full border-2 border-green-500/30 animate-ping" />
        </div>
        <div className="text-center">
          <p className="text-xl font-semibold text-white">Scanning Device Security...</p>
          <p className="text-neutral-500 mt-2">Checking vulnerabilities, permissions, and threats</p>
        </div>
      </div>
    );
  }

  if (!score || !vulnScan) return null;

  return (
    <div className="space-y-8 max-w-7xl mx-auto">
      {/* Security Score Hero */}
      <div className="bg-neutral-900/50 rounded-3xl border border-neutral-800 p-8">
        <div className="flex flex-col md:flex-row items-center gap-8">
          <ScoreRing score={score.overall} grade={score.grade} size={180} />
          <div className="flex-1 text-center md:text-left">
            <h3 className="text-2xl font-bold text-white mb-2">Security Score</h3>
            <p className="text-neutral-400 mb-4">{getGradeDescription(score.grade)}</p>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
              {Object.entries(score.breakdown).map(([key, value]) => (
                <div key={key} className="bg-neutral-800/50 rounded-xl p-3">
                  <p className="text-xs text-neutral-500 capitalize">{key.replace(/([A-Z])/g, ' $1').trim()}</p>
                  <p className="text-lg font-bold text-white">{value}<span className="text-sm text-neutral-500">/100</span></p>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* Quick Stats */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <StatCard
          title="Vulnerabilities"
          value={vulnScan.totalFound}
          subtitle={`${vulnScan.criticalCount} critical`}
          icon={<Bug size={20} />}
          color={vulnScan.criticalCount > 0 ? 'red' : vulnScan.totalFound > 0 ? 'yellow' : 'green'}
          onClick={() => onNavigate('vulnerabilities')}
        />
        <StatCard
          title="Dangerous Permissions"
          value={permissionCount}
          subtitle="granted to apps"
          icon={<Lock size={20} />}
          color={permissionCount > 5 ? 'red' : permissionCount > 2 ? 'yellow' : 'green'}
          onClick={() => onNavigate('permissions')}
        />
        <StatCard
          title="Patch Level"
          value={vulnScan.patchLevel}
          subtitle={score.breakdown.patchLevel >= 85 ? 'Up to date' : 'Update available'}
          icon={<Shield size={20} />}
          color={score.breakdown.patchLevel >= 85 ? 'green' : 'orange'}
        />
        <StatCard
          title="Stalkerware"
          value={0}
          subtitle="None detected"
          icon={<AlertTriangle size={20} />}
          color="green"
        />
      </div>

      {/* Quick Actions */}
      <div>
        <h3 className="text-lg font-semibold text-white mb-4">Quick Actions</h3>
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
          {[
            { icon: <Scan size={20} />, label: 'Scan CVEs', page: 'vulnerabilities', color: 'text-red-400' },
            { icon: <Globe size={20} />, label: 'Check URL', page: 'url-scanner', color: 'text-blue-400' },
            { icon: <FileSearch size={20} />, label: 'Scan File', page: 'file-scanner', color: 'text-purple-400' },
            { icon: <Wifi size={20} />, label: 'Wi-Fi Check', page: 'wifi', color: 'text-cyan-400' },
            { icon: <Smartphone size={20} />, label: 'Compare Devices', page: 'devices', color: 'text-orange-400' },
          ].map((action) => (
            <button
              key={action.page}
              onClick={() => onNavigate(action.page)}
              className="flex flex-col items-center gap-2 p-4 bg-neutral-900/50 rounded-2xl border border-neutral-800 hover:border-neutral-700 hover:bg-neutral-800/50 transition-all"
            >
              <div className={action.color}>{action.icon}</div>
              <span className="text-sm text-neutral-300">{action.label}</span>
            </button>
          ))}
        </div>
      </div>

      {/* Recent Vulnerabilities */}
      {vulnScan.vulnerabilities.length > 0 && (
        <div>
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg font-semibold text-white">Recent Vulnerabilities</h3>
            <button
              onClick={() => onNavigate('vulnerabilities')}
              className="text-sm text-green-400 hover:text-green-300 transition-colors"
            >
              View All
            </button>
          </div>
          <div className="space-y-3">
            {vulnScan.vulnerabilities.slice(0, 5).map((cve) => (
              <div
                key={cve.id}
                className="bg-neutral-900/50 rounded-xl border border-neutral-800 p-4 flex items-start gap-4 hover:border-neutral-700 transition-colors"
              >
                <div className="mt-1">
                  <SeverityBadge severity={cve.severity} />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="font-mono text-sm font-semibold text-white">{cve.id}</span>
                    {cve.cvssScore && (
                      <span className="text-xs text-neutral-500">CVSS {cve.cvssScore}</span>
                    )}
                  </div>
                  <p className="text-sm text-neutral-400 line-clamp-2">{cve.description}</p>
                </div>
                {cve.exploitAvailable && (
                  <span className="text-xs bg-red-500/20 text-red-400 px-2 py-1 rounded-full border border-red-500/30 whitespace-nowrap">
                    Exploit Available
                  </span>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Device Info */}
      <div className="bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6">
        <h3 className="text-lg font-semibold text-white mb-4">Device Information</h3>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {[
            { label: 'Device', value: vulnScan.deviceModel },
            { label: 'OS Version', value: vulnScan.osVersion },
            { label: 'Patch Level', value: vulnScan.patchLevel },
            { label: 'Last Scan', value: new Date(vulnScan.scanDate).toLocaleString() },
          ].map((info) => (
            <div key={info.label}>
              <p className="text-xs text-neutral-500 mb-1">{info.label}</p>
              <p className="text-sm font-medium text-white truncate">{info.value}</p>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
