import React, { useState, useEffect } from 'react';
import { Scan, ExternalLink, AlertCircle, CheckCircle, Shield } from 'lucide-react';
import SeverityBadge from '../components/SeverityBadge';
import {
  scanDeviceVulnerabilities,
  getKnownCVEs,
  fetchNVDCves,
} from '@shared/services/cveService';
import type { CVEEntry, VulnerabilityScanResult } from '@shared/models/types';

export default function VulnerabilityScanner() {
  const [scanResult, setScanResult] = useState<VulnerabilityScanResult | null>(null);
  const [allCVEs, setAllCVEs] = useState<CVEEntry[]>([]);
  const [scanning, setScanning] = useState(false);
  const [filter, setFilter] = useState<string>('ALL');
  const [searchQuery, setSearchQuery] = useState('');
  const [osVersion, setOsVersion] = useState('14');
  const [patchLevel, setPatchLevel] = useState('2025-01-01');

  useEffect(() => {
    setAllCVEs(getKnownCVEs());
  }, []);

  async function runScan() {
    setScanning(true);
    const result = scanDeviceVulnerabilities(osVersion, patchLevel, 'User Device');
    // Also try fetching from NVD
    try {
      const nvdCves = await fetchNVDCves('android');
      if (nvdCves.length > allCVEs.length) {
        setAllCVEs(nvdCves);
      }
    } catch {
      // Use local database
    }
    setScanResult(result);
    setScanning(false);
  }

  const displayCVEs = scanResult ? scanResult.vulnerabilities : allCVEs;
  const filteredCVEs = displayCVEs.filter((cve) => {
    if (filter !== 'ALL' && cve.severity !== filter) return false;
    if (searchQuery && !cve.id.toLowerCase().includes(searchQuery.toLowerCase()) && !cve.description.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });

  return (
    <div className="space-y-6 max-w-5xl mx-auto">
      {/* Scan Configuration */}
      <div className="bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6">
        <h3 className="text-lg font-semibold text-white mb-4">Device Configuration</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label className="text-sm text-neutral-400 block mb-2">Android Version</label>
            <select
              value={osVersion}
              onChange={(e) => setOsVersion(e.target.value)}
              className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-green-500/50"
            >
              {['15', '14', '13', '12', '11', '10'].map((v) => (
                <option key={v} value={v}>Android {v}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="text-sm text-neutral-400 block mb-2">Security Patch Level</label>
            <input
              type="date"
              value={patchLevel}
              onChange={(e) => setPatchLevel(e.target.value)}
              className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-green-500/50"
            />
          </div>
          <div className="flex items-end">
            <button
              onClick={runScan}
              disabled={scanning}
              className="w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-500 disabled:bg-neutral-700 text-white font-semibold py-3 px-6 rounded-xl transition-all"
            >
              {scanning ? (
                <>
                  <Scan size={18} className="animate-spin" />
                  Scanning...
                </>
              ) : (
                <>
                  <Scan size={18} />
                  Scan for Vulnerabilities
                </>
              )}
            </button>
          </div>
        </div>
      </div>

      {/* Scan Results Summary */}
      {scanResult && (
        <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
          <div className="bg-neutral-900/50 rounded-xl border border-neutral-800 p-4 text-center">
            <p className="text-2xl font-bold text-white">{scanResult.totalFound}</p>
            <p className="text-xs text-neutral-500">Total Found</p>
          </div>
          <div className="bg-red-500/10 rounded-xl border border-red-500/20 p-4 text-center">
            <p className="text-2xl font-bold text-red-400">{scanResult.criticalCount}</p>
            <p className="text-xs text-neutral-500">Critical</p>
          </div>
          <div className="bg-orange-500/10 rounded-xl border border-orange-500/20 p-4 text-center">
            <p className="text-2xl font-bold text-orange-400">{scanResult.highCount}</p>
            <p className="text-xs text-neutral-500">High</p>
          </div>
          <div className="bg-yellow-500/10 rounded-xl border border-yellow-500/20 p-4 text-center">
            <p className="text-2xl font-bold text-yellow-400">{scanResult.mediumCount}</p>
            <p className="text-xs text-neutral-500">Medium</p>
          </div>
          <div className="bg-blue-500/10 rounded-xl border border-blue-500/20 p-4 text-center">
            <p className="text-2xl font-bold text-blue-400">{scanResult.lowCount}</p>
            <p className="text-xs text-neutral-500">Low</p>
          </div>
        </div>
      )}

      {/* Filters */}
      <div className="flex flex-col md:flex-row gap-4">
        <input
          type="text"
          placeholder="Search CVEs..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="flex-1 bg-neutral-900/50 border border-neutral-800 rounded-xl px-4 py-3 text-white placeholder-neutral-500 focus:outline-none focus:border-green-500/50"
        />
        <div className="flex gap-2 overflow-x-auto scrollbar-hide">
          {['ALL', 'CRITICAL', 'HIGH', 'MEDIUM', 'LOW'].map((sev) => (
            <button
              key={sev}
              onClick={() => setFilter(sev)}
              className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
                filter === sev
                  ? 'bg-green-500/20 text-green-400 border border-green-500/30'
                  : 'bg-neutral-800 text-neutral-400 border border-neutral-700 hover:bg-neutral-700'
              }`}
            >
              {sev}
            </button>
          ))}
        </div>
      </div>

      {/* CVE List */}
      <div className="space-y-3">
        {filteredCVEs.length === 0 ? (
          <div className="text-center py-12">
            <CheckCircle size={48} className="text-green-400 mx-auto mb-4" />
            <p className="text-lg font-semibold text-white">No vulnerabilities found</p>
            <p className="text-neutral-500">Your device appears secure against known CVEs</p>
          </div>
        ) : (
          filteredCVEs.map((cve) => (
            <div
              key={cve.id}
              className="bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5 hover:border-neutral-700 transition-all"
            >
              <div className="flex items-start justify-between gap-4 mb-3">
                <div className="flex items-center gap-3">
                  <SeverityBadge severity={cve.severity} size="md" />
                  <span className="font-mono text-base font-bold text-white">{cve.id}</span>
                  {cve.cvssScore && (
                    <span className="text-sm text-neutral-500">CVSS {cve.cvssScore}</span>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  {cve.exploitAvailable && (
                    <span className="text-xs bg-red-500/20 text-red-400 px-2.5 py-1 rounded-full border border-red-500/30">
                      Exploit Available
                    </span>
                  )}
                </div>
              </div>
              <p className="text-sm text-neutral-300 mb-3">{cve.description}</p>
              <div className="flex flex-wrap gap-4 text-xs text-neutral-500">
                <span>Published: {new Date(cve.publishedDate).toLocaleDateString()}</span>
                {cve.patchedIn && <span>Patched: {cve.patchedIn}</span>}
                <span>Affected: {cve.affectedVersions.join(', ')}</span>
              </div>
              {cve.references.length > 0 && (
                <div className="mt-3 flex gap-2">
                  {cve.references.slice(0, 2).map((ref, i) => (
                    <a
                      key={i}
                      href={ref}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-xs text-green-400 hover:text-green-300 flex items-center gap-1"
                    >
                      <ExternalLink size={12} />
                      Reference {i + 1}
                    </a>
                  ))}
                </div>
              )}
            </div>
          ))
        )}
      </div>
    </div>
  );
}
