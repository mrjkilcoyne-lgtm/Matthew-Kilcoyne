import React, { useState } from 'react';
import { BarChart3, TrendingUp, TrendingDown, Clock, Shield, AlertTriangle, CheckCircle } from 'lucide-react';
import ScoreRing from '../components/ScoreRing';
import SeverityBadge from '../components/SeverityBadge';
import type { SecurityHistoryEntry, SecurityEvent } from '@shared/models/types';

// Sample history data for demonstration
const SAMPLE_HISTORY: SecurityHistoryEntry[] = [
  {
    date: '2026-02-28T10:00:00Z',
    score: 78,
    grade: 'B',
    events: [
      { type: 'SCAN', description: 'Full device scan completed', severity: 'INFO', timestamp: '2026-02-28T10:00:00Z' },
      { type: 'THREAT_DETECTED', description: 'CVE-2024-53104 vulnerability detected', severity: 'DANGER', timestamp: '2026-02-28T10:01:00Z' },
    ],
  },
  {
    date: '2026-02-25T14:00:00Z',
    score: 72,
    grade: 'B',
    events: [
      { type: 'APP_INSTALLED', description: 'New app installed: SuperChat', severity: 'INFO', timestamp: '2026-02-25T14:00:00Z' },
      { type: 'PERMISSION_CHANGED', description: 'Camera permission granted to SuperChat', severity: 'WARNING', timestamp: '2026-02-25T14:05:00Z' },
    ],
  },
  {
    date: '2026-02-20T09:00:00Z',
    score: 85,
    grade: 'A',
    events: [
      { type: 'OS_UPDATE', description: 'Security patch applied: 2025-02-01', severity: 'INFO', timestamp: '2026-02-20T09:00:00Z' },
      { type: 'THREAT_RESOLVED', description: 'CVE-2024-43093 patched', severity: 'INFO', timestamp: '2026-02-20T09:01:00Z' },
    ],
  },
  {
    date: '2026-02-15T16:00:00Z',
    score: 65,
    grade: 'C',
    events: [
      { type: 'THREAT_DETECTED', description: 'Suspicious app behavior detected', severity: 'DANGER', timestamp: '2026-02-15T16:00:00Z' },
      { type: 'APP_REMOVED', description: 'Malicious app removed: FakeFlash', severity: 'INFO', timestamp: '2026-02-15T16:10:00Z' },
    ],
  },
  {
    date: '2026-02-10T11:00:00Z',
    score: 60,
    grade: 'C',
    events: [
      { type: 'SCAN', description: 'Scheduled scan completed', severity: 'INFO', timestamp: '2026-02-10T11:00:00Z' },
    ],
  },
  {
    date: '2026-02-05T08:00:00Z',
    score: 55,
    grade: 'C',
    events: [
      { type: 'SETTINGS_CHANGED', description: 'USB debugging enabled', severity: 'WARNING', timestamp: '2026-02-05T08:00:00Z' },
    ],
  },
];

export default function SecurityHistory() {
  const [history] = useState<SecurityHistoryEntry[]>(SAMPLE_HISTORY);
  const [selectedEntry, setSelectedEntry] = useState<SecurityHistoryEntry | null>(null);

  const latestScore = history[0]?.score || 0;
  const oldestScore = history[history.length - 1]?.score || 0;
  const trend = latestScore - oldestScore;
  const maxScore = Math.max(...history.map((h) => h.score));
  const minScore = Math.min(...history.map((h) => h.score));

  const allEvents = history.flatMap((h) => h.events).sort(
    (a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
  );

  function getEventIcon(type: SecurityEvent['type']): React.ReactNode {
    switch (type) {
      case 'SCAN': return <Shield size={16} className="text-blue-400" />;
      case 'THREAT_DETECTED': return <AlertTriangle size={16} className="text-red-400" />;
      case 'THREAT_RESOLVED': return <CheckCircle size={16} className="text-green-400" />;
      case 'APP_INSTALLED': return <Shield size={16} className="text-purple-400" />;
      case 'APP_REMOVED': return <Shield size={16} className="text-orange-400" />;
      case 'PERMISSION_CHANGED': return <Shield size={16} className="text-yellow-400" />;
      case 'OS_UPDATE': return <Shield size={16} className="text-green-400" />;
      case 'SETTINGS_CHANGED': return <Shield size={16} className="text-yellow-400" />;
    }
  }

  function getScoreGrade(score: number): string {
    if (score >= 95) return 'A+';
    if (score >= 85) return 'A';
    if (score >= 70) return 'B';
    if (score >= 55) return 'C';
    if (score >= 40) return 'D';
    return 'F';
  }

  return (
    <div className="space-y-6 max-w-5xl mx-auto">
      {/* Overview Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5">
          <p className="text-xs text-neutral-500 mb-2">Current Score</p>
          <p className="text-3xl font-bold text-white">{latestScore}</p>
        </div>
        <div className={`rounded-2xl border p-5 ${
          trend >= 0 ? 'bg-green-500/10 border-green-500/20' : 'bg-red-500/10 border-red-500/20'
        }`}>
          <p className="text-xs text-neutral-500 mb-2">Trend</p>
          <div className="flex items-center gap-2">
            {trend >= 0 ? (
              <TrendingUp size={20} className="text-green-400" />
            ) : (
              <TrendingDown size={20} className="text-red-400" />
            )}
            <span className={`text-3xl font-bold ${trend >= 0 ? 'text-green-400' : 'text-red-400'}`}>
              {trend >= 0 ? '+' : ''}{trend}
            </span>
          </div>
        </div>
        <div className="bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5">
          <p className="text-xs text-neutral-500 mb-2">Peak Score</p>
          <p className="text-3xl font-bold text-green-400">{maxScore}</p>
        </div>
        <div className="bg-neutral-900/50 rounded-2xl border border-neutral-800 p-5">
          <p className="text-xs text-neutral-500 mb-2">Low Score</p>
          <p className="text-3xl font-bold text-red-400">{minScore}</p>
        </div>
      </div>

      {/* Score Timeline Chart */}
      <div className="bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6">
        <h3 className="text-lg font-semibold text-white mb-6">Score Timeline</h3>
        <div className="flex items-end justify-between gap-2 h-40">
          {[...history].reverse().map((entry, i) => {
            const height = (entry.score / 100) * 100;
            return (
              <button
                key={entry.date}
                onClick={() => setSelectedEntry(entry)}
                className="flex-1 flex flex-col items-center gap-2 group"
              >
                <span className="text-xs text-neutral-500 opacity-0 group-hover:opacity-100 transition-opacity">
                  {entry.score}
                </span>
                <div
                  className={`w-full rounded-t-lg transition-all group-hover:opacity-80 ${
                    entry.score >= 85 ? 'bg-green-500' :
                    entry.score >= 70 ? 'bg-green-600' :
                    entry.score >= 55 ? 'bg-yellow-500' :
                    entry.score >= 40 ? 'bg-orange-500' : 'bg-red-500'
                  } ${selectedEntry?.date === entry.date ? 'ring-2 ring-white/30' : ''}`}
                  style={{ height: `${height}%` }}
                />
                <span className="text-xs text-neutral-600 truncate w-full text-center">
                  {new Date(entry.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}
                </span>
              </button>
            );
          })}
        </div>
      </div>

      {/* Selected Entry Detail */}
      {selectedEntry && (
        <div className="bg-neutral-900/50 rounded-2xl border border-green-500/20 p-6 animate-fade-in">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h4 className="text-lg font-semibold text-white">
                {new Date(selectedEntry.date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
              </h4>
              <p className="text-sm text-neutral-500">{selectedEntry.events.length} events</p>
            </div>
            <ScoreRing score={selectedEntry.score} grade={getScoreGrade(selectedEntry.score)} size={80} strokeWidth={4} />
          </div>
          <div className="space-y-2">
            {selectedEntry.events.map((event, i) => (
              <div key={i} className="flex items-start gap-3 bg-neutral-800/50 rounded-xl p-3">
                {getEventIcon(event.type)}
                <div className="flex-1">
                  <p className="text-sm text-white">{event.description}</p>
                  <p className="text-xs text-neutral-500">{new Date(event.timestamp).toLocaleTimeString()}</p>
                </div>
                <SeverityBadge severity={event.severity} />
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Event Timeline */}
      <div className="bg-neutral-900/50 rounded-2xl border border-neutral-800 p-6">
        <h3 className="text-lg font-semibold text-white mb-4">All Security Events</h3>
        <div className="space-y-3">
          {allEvents.map((event, i) => (
            <div key={i} className="flex items-start gap-3 border-l-2 border-neutral-700 pl-4 py-2">
              <div className="mt-0.5">{getEventIcon(event.type)}</div>
              <div className="flex-1">
                <p className="text-sm text-white">{event.description}</p>
                <p className="text-xs text-neutral-500 flex items-center gap-2">
                  <Clock size={12} />
                  {new Date(event.timestamp).toLocaleString()}
                </p>
              </div>
              <SeverityBadge severity={event.severity} />
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
