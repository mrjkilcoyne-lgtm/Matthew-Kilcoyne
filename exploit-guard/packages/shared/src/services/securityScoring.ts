import type { SecurityScore, DashboardData, SecurityEvent, SecurityHistoryEntry } from '../models/types';
import { calculatePatchScore } from './cveService';

/**
 * Calculate overall security score for a device
 */
export function calculateSecurityScore(params: {
  osVersion: string;
  patchLevel: string;
  vulnerabilityCount: number;
  dangerousPermissions: number;
  stalkerwareCount: number;
  openPorts: number;
  isEncrypted: boolean;
  hasLockScreen: boolean;
  isRooted: boolean;
  debuggingEnabled: boolean;
}): SecurityScore {
  const breakdown = {
    osVersion: calculateOSScore(params.osVersion),
    patchLevel: calculatePatchScore(params.patchLevel),
    permissions: calculatePermissionScore(params.dangerousPermissions),
    networkSecurity: calculateNetworkScore(params.openPorts),
    appSecurity: calculateAppSecurityScore(params.vulnerabilityCount, params.isRooted, params.debuggingEnabled),
    stalkerwareRisk: params.stalkerwareCount === 0 ? 100 : Math.max(0, 100 - params.stalkerwareCount * 40),
  };

  // Weighted average
  const weights = {
    osVersion: 0.15,
    patchLevel: 0.25,
    permissions: 0.15,
    networkSecurity: 0.10,
    appSecurity: 0.20,
    stalkerwareRisk: 0.15,
  };

  let overall = 0;
  for (const [key, weight] of Object.entries(weights)) {
    overall += breakdown[key as keyof typeof breakdown] * weight;
  }

  // Bonus/penalty factors
  if (!params.hasLockScreen) overall -= 10;
  if (!params.isEncrypted) overall -= 10;
  if (params.isRooted) overall -= 15;
  if (params.debuggingEnabled) overall -= 5;

  overall = Math.max(0, Math.min(100, Math.round(overall)));

  return {
    overall,
    grade: scoreToGrade(overall),
    breakdown,
    lastScanned: new Date().toISOString(),
  };
}

function calculateOSScore(osVersion: string): number {
  const version = parseInt(osVersion.replace(/[^\d]/g, '').slice(0, 2), 10);
  if (version >= 15) return 100;
  if (version >= 14) return 90;
  if (version >= 13) return 75;
  if (version >= 12) return 60;
  if (version >= 11) return 40;
  return 20;
}

function calculatePermissionScore(dangerousCount: number): number {
  if (dangerousCount <= 3) return 100;
  if (dangerousCount <= 6) return 80;
  if (dangerousCount <= 10) return 60;
  if (dangerousCount <= 15) return 40;
  return 20;
}

function calculateNetworkScore(openPorts: number): number {
  if (openPorts === 0) return 100;
  if (openPorts <= 2) return 80;
  if (openPorts <= 5) return 60;
  return 30;
}

function calculateAppSecurityScore(vulnCount: number, isRooted: boolean, debugEnabled: boolean): number {
  let score = 100;
  score -= vulnCount * 8;
  if (isRooted) score -= 25;
  if (debugEnabled) score -= 10;
  return Math.max(0, score);
}

function scoreToGrade(score: number): SecurityScore['grade'] {
  if (score >= 95) return 'A+';
  if (score >= 85) return 'A';
  if (score >= 70) return 'B';
  if (score >= 55) return 'C';
  if (score >= 40) return 'D';
  return 'F';
}

/**
 * Generate dashboard data from current state
 */
export function generateDashboardData(params: {
  securityScore: SecurityScore;
  installedApps: number;
  riskyApps: number;
  stalkerwareDetected: number;
  activeFirewallRules: number;
  blockedConnections: number;
  pendingUpdates: number;
  recentEvents: SecurityEvent[];
}): DashboardData {
  return {
    securityScore: params.securityScore,
    recentThreats: params.recentEvents.filter((e) => e.severity === 'DANGER' || e.severity === 'WARNING'),
    installedApps: params.installedApps,
    riskyApps: params.riskyApps,
    stalkerwareDetected: params.stalkerwareDetected,
    lastScanDate: params.securityScore.lastScanned,
    pendingUpdates: params.pendingUpdates,
    activeFirewallRules: params.activeFirewallRules,
    blockedConnections: params.blockedConnections,
  };
}

/**
 * Create a security history entry
 */
export function createHistoryEntry(score: SecurityScore, events: SecurityEvent[]): SecurityHistoryEntry {
  return {
    date: new Date().toISOString(),
    score: score.overall,
    grade: score.grade,
    events,
  };
}

/**
 * Get color for score display
 */
export function getScoreColor(score: number): string {
  if (score >= 85) return '#22c55e'; // green
  if (score >= 70) return '#84cc16'; // lime
  if (score >= 55) return '#eab308'; // yellow
  if (score >= 40) return '#f97316'; // orange
  return '#ef4444'; // red
}

/**
 * Get grade description
 */
export function getGradeDescription(grade: SecurityScore['grade']): string {
  switch (grade) {
    case 'A+':
      return 'Excellent - Your device is extremely well protected';
    case 'A':
      return 'Very Good - Strong security posture with minor improvements possible';
    case 'B':
      return 'Good - Reasonable security but some areas need attention';
    case 'C':
      return 'Fair - Several security concerns should be addressed';
    case 'D':
      return 'Poor - Significant vulnerabilities present, action required';
    case 'F':
      return 'Critical - Device is highly vulnerable, immediate action needed';
  }
}
