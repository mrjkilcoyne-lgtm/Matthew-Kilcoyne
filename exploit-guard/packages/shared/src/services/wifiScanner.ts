import type { WiFiScanResult, CVEEntry } from '../models/types';

// Known router vulnerabilities
const ROUTER_CVES: CVEEntry[] = [
  {
    id: 'CVE-2023-1389',
    severity: 'HIGH',
    description: 'TP-Link Archer AX21 command injection vulnerability in web management interface.',
    affectedVersions: ['TP-Link Archer AX21'],
    patchedIn: '2023-03',
    publishedDate: '2023-03-15',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2023-1389'],
    cvssScore: 8.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2024-3080',
    severity: 'CRITICAL',
    description: 'ASUS routers authentication bypass allowing remote unauthenticated access.',
    affectedVersions: ['ASUS RT-AX series', 'ASUS RT-AC series'],
    patchedIn: '2024-06',
    publishedDate: '2024-06-14',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2024-3080'],
    cvssScore: 9.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2023-28771',
    severity: 'CRITICAL',
    description: 'Zyxel firewall OS command injection via crafted IKEv2 packets.',
    affectedVersions: ['Zyxel USG/ATP/VPN series'],
    publishedDate: '2023-04-25',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2023-28771'],
    cvssScore: 9.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2023-20198',
    severity: 'CRITICAL',
    description: 'Cisco IOS XE privilege escalation via web UI.',
    affectedVersions: ['Cisco IOS XE'],
    patchedIn: '2023-10',
    publishedDate: '2023-10-16',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2023-20198'],
    cvssScore: 10.0,
    exploitAvailable: true,
  },
];

/**
 * Analyze Wi-Fi security based on available information
 * Note: Full Wi-Fi scanning requires native APIs (unavailable in browsers)
 */
export function analyzeWiFiSecurity(params: {
  ssid: string;
  bssid?: string;
  encryption?: WiFiScanResult['encryption'];
  signalStrength?: number;
  frequency?: number;
  isPublic?: boolean;
}): WiFiScanResult {
  const risks: string[] = [];
  let securityScore = 100;
  const encryption = params.encryption || 'OPEN';

  // Encryption assessment
  switch (encryption) {
    case 'OPEN':
      risks.push('Network has no encryption - all traffic is visible to anyone nearby');
      securityScore -= 50;
      break;
    case 'WEP':
      risks.push('WEP encryption is broken and can be cracked in minutes');
      securityScore -= 40;
      break;
    case 'WPA':
      risks.push('WPA encryption has known vulnerabilities - upgrade to WPA2 or WPA3');
      securityScore -= 20;
      break;
    case 'WPA2':
      // WPA2 is acceptable but WPA3 is better
      if (!params.ssid.toLowerCase().includes('5g')) {
        risks.push('Consider upgrading to WPA3 for enhanced security');
        securityScore -= 5;
      }
      break;
    case 'WPA3':
      // Best available
      break;
  }

  // Public network check
  if (params.isPublic) {
    risks.push('Public Wi-Fi networks are susceptible to man-in-the-middle attacks');
    risks.push('Avoid accessing sensitive accounts on public networks');
    securityScore -= 20;
  }

  // SSID-based risk analysis
  const ssidLower = params.ssid.toLowerCase();
  if (ssidLower.includes('free') || ssidLower.includes('guest') || ssidLower.includes('public')) {
    risks.push('Network name suggests it is publicly accessible');
    securityScore -= 10;
  }

  // Check for default/common SSIDs (potential evil twin)
  const commonSSIDs = ['linksys', 'netgear', 'default', 'dlink', 'home', 'xfinity', 'att', 'verizon', 'tmobile'];
  if (commonSSIDs.some((s) => ssidLower.includes(s))) {
    risks.push('Common/default SSID detected - could be an evil twin attack');
    securityScore -= 5;
  }

  // Hidden SSID check
  if (params.ssid === '' || params.ssid === '<hidden>') {
    risks.push('Hidden SSID detected - this does not improve security and may indicate suspicious setup');
    securityScore -= 5;
  }

  // Signal strength analysis
  const signalStrength = params.signalStrength || -50;
  if (signalStrength > -30) {
    risks.push('Very strong signal - verify this is your expected network (not a nearby rogue AP)');
  }

  securityScore = Math.max(0, securityScore);

  return {
    ssid: params.ssid,
    bssid: params.bssid || 'unknown',
    encryption,
    signalStrength,
    frequency: params.frequency || 2400,
    securityScore,
    risks,
    routerVulnerabilities: [], // Would require router fingerprinting
    isPublic: params.isPublic || false,
  };
}

/**
 * Check if the current connection is using HTTPS
 */
export function checkConnectionSecurity(): {
  isSecure: boolean;
  protocol: string;
  warnings: string[];
} {
  if (typeof window === 'undefined') {
    return { isSecure: false, protocol: 'unknown', warnings: ['Not in browser environment'] };
  }

  const warnings: string[] = [];
  const isSecure = window.location.protocol === 'https:';

  if (!isSecure) {
    warnings.push('Connection is not encrypted (HTTP). Data may be intercepted.');
  }

  return {
    isSecure,
    protocol: window.location.protocol,
    warnings,
  };
}

/**
 * Get known router vulnerabilities
 */
export function getRouterVulnerabilities(): CVEEntry[] {
  return [...ROUTER_CVES];
}

/**
 * Estimate Wi-Fi security recommendations
 */
export function getWiFiRecommendations(scanResult: WiFiScanResult): string[] {
  const recommendations: string[] = [];

  if (scanResult.encryption === 'OPEN' || scanResult.encryption === 'WEP') {
    recommendations.push('Use a VPN when connected to this network');
    recommendations.push('Avoid online banking or entering passwords');
    recommendations.push('Upgrade router encryption to WPA3 if possible');
  }

  if (scanResult.isPublic) {
    recommendations.push('Enable your device firewall');
    recommendations.push('Disable file sharing and AirDrop');
    recommendations.push('Use HTTPS-only mode in your browser');
    recommendations.push('Consider using a trusted VPN service');
  }

  if (scanResult.securityScore < 50) {
    recommendations.push('Change your Wi-Fi password regularly');
    recommendations.push('Disable WPS (Wi-Fi Protected Setup)');
    recommendations.push('Update router firmware to latest version');
    recommendations.push('Change default router admin credentials');
  }

  return recommendations;
}
