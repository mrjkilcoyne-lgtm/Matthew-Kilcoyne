import type { CVEEntry, VulnerabilityScanResult } from '../models/types';

// Known Android CVE database (curated high-impact vulnerabilities)
const KNOWN_CVES: CVEEntry[] = [
  {
    id: 'CVE-2024-53104',
    severity: 'HIGH',
    description: 'USB Video Class driver out-of-bounds write vulnerability in Linux kernel, actively exploited on Android devices.',
    affectedVersions: ['Android 12', 'Android 13', 'Android 14', 'Android 15'],
    patchedIn: '2025-02-01',
    publishedDate: '2024-12-02',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2024-53104'],
    cvssScore: 7.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2024-53197',
    severity: 'HIGH',
    description: 'Linux kernel ALSA USB audio driver out-of-bounds access, exploited in targeted attacks.',
    affectedVersions: ['Android 13', 'Android 14', 'Android 15'],
    patchedIn: '2025-04-01',
    publishedDate: '2024-12-27',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2024-53197'],
    cvssScore: 7.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2025-27363',
    severity: 'HIGH',
    description: 'FreeType library out-of-bounds write when parsing TrueType GX and variable font files.',
    affectedVersions: ['Android 13', 'Android 14', 'Android 15'],
    patchedIn: '2025-05-01',
    publishedDate: '2025-03-11',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2025-27363'],
    cvssScore: 8.1,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2024-43093',
    severity: 'HIGH',
    description: 'Android Framework privilege escalation allowing unauthorized access to sensitive directories.',
    affectedVersions: ['Android 12', 'Android 13', 'Android 14', 'Android 15'],
    patchedIn: '2024-11-01',
    publishedDate: '2024-11-04',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2024-43093'],
    cvssScore: 7.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2024-43047',
    severity: 'HIGH',
    description: 'Qualcomm DSP Service use-after-free vulnerability, exploited in targeted surveillance campaigns.',
    affectedVersions: ['Android 12', 'Android 13', 'Android 14'],
    patchedIn: '2024-11-01',
    publishedDate: '2024-10-07',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2024-43047'],
    cvssScore: 7.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2024-36971',
    severity: 'HIGH',
    description: 'Linux kernel network route management use-after-free enabling remote code execution.',
    affectedVersions: ['Android 12', 'Android 13', 'Android 14'],
    patchedIn: '2024-08-01',
    publishedDate: '2024-06-10',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2024-36971'],
    cvssScore: 7.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2024-32896',
    severity: 'HIGH',
    description: 'Pixel firmware logic error allowing privilege escalation through user interaction.',
    affectedVersions: ['Android 14', 'Android 15'],
    patchedIn: '2024-09-01',
    publishedDate: '2024-06-13',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2024-32896'],
    cvssScore: 7.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2023-40088',
    severity: 'CRITICAL',
    description: 'Bluetooth callback use-after-free in Android System leading to remote code execution.',
    affectedVersions: ['Android 11', 'Android 12', 'Android 13', 'Android 14'],
    patchedIn: '2023-12-01',
    publishedDate: '2023-12-04',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2023-40088'],
    cvssScore: 8.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2023-4863',
    severity: 'CRITICAL',
    description: 'libwebp heap buffer overflow affecting Chrome, Android WebView, and numerous applications.',
    affectedVersions: ['Android 11', 'Android 12', 'Android 13', 'Android 14'],
    patchedIn: '2023-10-01',
    publishedDate: '2023-09-12',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2023-4863'],
    cvssScore: 8.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2023-21036',
    severity: 'HIGH',
    description: 'aCropalypse: Pixel Markup tool fails to truncate edited screenshots, exposing cropped content.',
    affectedVersions: ['Android 10', 'Android 11', 'Android 12', 'Android 13'],
    patchedIn: '2023-03-01',
    publishedDate: '2023-03-24',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2023-21036'],
    cvssScore: 7.5,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2024-0044',
    severity: 'HIGH',
    description: 'Android run-as vulnerability allowing any app to impersonate other applications.',
    affectedVersions: ['Android 12', 'Android 12L', 'Android 13', 'Android 14'],
    patchedIn: '2024-04-01',
    publishedDate: '2024-03-11',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2024-0044'],
    cvssScore: 7.8,
    exploitAvailable: true,
  },
  {
    id: 'CVE-2023-45779',
    severity: 'HIGH',
    description: 'APEX module installation flaw allowing unsigned code to persist across reboots.',
    affectedVersions: ['Android 13', 'Android 14'],
    patchedIn: '2023-12-01',
    publishedDate: '2024-01-08',
    references: ['https://nvd.nist.gov/vuln/detail/CVE-2023-45779'],
    cvssScore: 7.8,
    exploitAvailable: true,
  },
];

/**
 * Fetch CVEs from NVD API for Android-specific vulnerabilities
 */
export async function fetchNVDCves(keyword: string = 'android'): Promise<CVEEntry[]> {
  try {
    const url = `https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=${encodeURIComponent(keyword)}&resultsPerPage=20&keywordExactMatch`;
    const response = await fetch(url);
    if (!response.ok) {
      console.warn('NVD API unavailable, using local database');
      return KNOWN_CVES;
    }
    const data = await response.json();
    const cves: CVEEntry[] = data.vulnerabilities?.map((v: any) => {
      const cve = v.cve;
      const metrics = cve.metrics?.cvssMetricV31?.[0] || cve.metrics?.cvssMetricV30?.[0];
      const cvssScore = metrics?.cvssData?.baseScore || 0;
      return {
        id: cve.id,
        severity: cvssScore >= 9 ? 'CRITICAL' : cvssScore >= 7 ? 'HIGH' : cvssScore >= 4 ? 'MEDIUM' : 'LOW',
        description: cve.descriptions?.find((d: any) => d.lang === 'en')?.value || '',
        affectedVersions: [],
        publishedDate: cve.published,
        references: cve.references?.map((r: any) => r.url) || [],
        cvssScore,
        exploitAvailable: false,
      };
    }) || [];
    return cves.length > 0 ? cves : KNOWN_CVES;
  } catch {
    return KNOWN_CVES;
  }
}

/**
 * Check a specific device against known CVEs
 */
export function scanDeviceVulnerabilities(
  osVersion: string,
  patchLevel: string,
  deviceModel: string = 'Unknown'
): VulnerabilityScanResult {
  const normalizedVersion = osVersion.replace(/[^\d.]/g, '');
  const majorVersion = parseInt(normalizedVersion.split('.')[0], 10);
  const androidVersion = `Android ${majorVersion}`;

  const patchDate = new Date(patchLevel);
  const now = new Date();

  const matched = KNOWN_CVES.filter((cve) => {
    const isAffected = cve.affectedVersions.some(
      (v) => v === androidVersion || v.startsWith(`Android ${majorVersion}`)
    );
    if (!isAffected) return false;
    if (cve.patchedIn) {
      const patchedDate = new Date(cve.patchedIn);
      return patchDate < patchedDate;
    }
    return true;
  });

  return {
    deviceModel,
    osVersion,
    patchLevel,
    vulnerabilities: matched,
    totalFound: matched.length,
    criticalCount: matched.filter((c) => c.severity === 'CRITICAL').length,
    highCount: matched.filter((c) => c.severity === 'HIGH').length,
    mediumCount: matched.filter((c) => c.severity === 'MEDIUM').length,
    lowCount: matched.filter((c) => c.severity === 'LOW').length,
    scanDate: now.toISOString(),
  };
}

/**
 * Get local curated CVE database
 */
export function getKnownCVEs(): CVEEntry[] {
  return [...KNOWN_CVES];
}

/**
 * Calculate patch delay score (0-100)
 */
export function calculatePatchScore(patchLevel: string): number {
  const patchDate = new Date(patchLevel);
  const now = new Date();
  const daysBehind = Math.floor((now.getTime() - patchDate.getTime()) / (1000 * 60 * 60 * 24));
  if (daysBehind <= 30) return 100;
  if (daysBehind <= 60) return 85;
  if (daysBehind <= 90) return 70;
  if (daysBehind <= 180) return 50;
  if (daysBehind <= 365) return 30;
  return 10;
}
