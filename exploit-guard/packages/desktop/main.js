/**
 * ExploitGuard Desktop App
 *
 * Electron wrapper that loads the web app and adds native desktop capabilities:
 * - System tray integration
 * - Native file scanning
 * - OS-level permission monitoring
 * - Background security monitoring
 *
 * For Windows deployment, build with: npm run build
 * For macOS: npm run build:mac
 * For Linux: npm run build:linux
 */

const { app, BrowserWindow, Tray, Menu, shell, ipcMain } = require('electron');
const path = require('path');

let mainWindow;
let tray;

const isDev = !app.isPackaged;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    minWidth: 800,
    minHeight: 600,
    title: 'ExploitGuard',
    icon: path.join(__dirname, 'assets', 'icon.png'),
    backgroundColor: '#0a0a0a',
    titleBarStyle: 'hiddenInset',
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js'),
    },
  });

  // Load the web app
  if (isDev) {
    mainWindow.loadURL('http://localhost:3001');
    mainWindow.webContents.openDevTools();
  } else {
    // In production, load the built web app
    mainWindow.loadFile(path.join(__dirname, '..', 'web', 'dist', 'index.html'));
  }

  // Open external links in the default browser
  mainWindow.webContents.setWindowOpenHandler(({ url }) => {
    shell.openExternal(url);
    return { action: 'deny' };
  });

  mainWindow.on('closed', () => {
    mainWindow = null;
  });

  // Minimize to tray instead of closing
  mainWindow.on('close', (event) => {
    if (!app.isQuiting) {
      event.preventDefault();
      mainWindow.hide();
    }
  });
}

function createTray() {
  // tray = new Tray(path.join(__dirname, 'assets', 'tray-icon.png'));

  const contextMenu = Menu.buildFromTemplate([
    {
      label: 'Open ExploitGuard',
      click: () => {
        if (mainWindow) {
          mainWindow.show();
          mainWindow.focus();
        }
      },
    },
    { type: 'separator' },
    {
      label: 'Quick Scan',
      click: () => {
        if (mainWindow) {
          mainWindow.show();
          mainWindow.webContents.send('quick-scan');
        }
      },
    },
    { type: 'separator' },
    {
      label: 'Quit',
      click: () => {
        app.isQuiting = true;
        app.quit();
      },
    },
  ]);

  // Uncomment when tray icon asset is available:
  // tray.setToolTip('ExploitGuard - Security Suite');
  // tray.setContextMenu(contextMenu);
  // tray.on('click', () => mainWindow?.show());
}

// IPC Handlers for native capabilities
ipcMain.handle('get-system-info', () => {
  const os = require('os');
  return {
    platform: os.platform(),
    release: os.release(),
    arch: os.arch(),
    hostname: os.hostname(),
    totalMemory: os.totalmem(),
    freeMemory: os.freemem(),
    cpus: os.cpus().length,
    uptime: os.uptime(),
  };
});

ipcMain.handle('get-network-interfaces', () => {
  const os = require('os');
  return os.networkInterfaces();
});

app.whenReady().then(() => {
  createWindow();
  createTray();

  app.on('activate', () => {
    if (BrowserWindow.getAllWindows().length === 0) {
      createWindow();
    }
  });
});

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});
